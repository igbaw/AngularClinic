var Pt=Object.defineProperty,vt=Object.defineProperties;var It=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var ye=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var he=(e,t,n)=>t in e?Pt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,f=(e,t)=>{for(var n in t||(t={}))ye.call(t,n)&&he(e,n,t[n]);if(W)for(var n of W(t))be.call(t,n)&&he(e,n,t[n]);return e},w=(e,t)=>vt(e,It(t));var we=(e,t)=>{var n={};for(var o in e)ye.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(e!=null&&W)for(var o of W(e))t.indexOf(o)<0&&be.call(e,o)&&(n[o]=e[o]);return n};var d=(e,t,n)=>new Promise((o,r)=>{var i=c=>{try{a(n.next(c))}catch(u){r(u)}},s=c=>{try{a(n.throw(c))}catch(u){r(u)}},a=c=>c.done?o(c.value):Promise.resolve(c.value).then(i,s);a((n=n.apply(e,t)).next())});import{APIError as Ar,createRouter as kr}from"better-call";import{APIError as Re}from"better-call";import{z as Te}from"zod";import{xchacha20poly1305 as Br}from"@noble/ciphers/chacha";import{bytesToHex as jr,hexToBytes as qr,utf8ToBytes as Nr}from"@noble/ciphers/utils";import{managedNonce as Fr}from"@noble/ciphers/webcrypto";import{sha256 as Vr}from"@noble/hashes/sha256";function J(e,t){return d(this,null,function*(){let n=new TextEncoder,o={name:"HMAC",hash:"SHA-256"},r=yield crypto.subtle.importKey("raw",n.encode(e),o,!1,["sign","verify"]),i=yield crypto.subtle.sign(o.name,r,n.encode(t));return btoa(String.fromCharCode(...new Uint8Array(i)))})}import{createEndpointCreator as St,createMiddleware as Ae,createMiddlewareCreator as Lt}from"better-call";var ke=Ae(()=>d(void 0,null,function*(){return{}})),Z=Lt({use:[ke,Ae(()=>d(void 0,null,function*(){return{}}))]}),h=St({use:[ke]});var xe=Z({body:Te.object({csrfToken:Te.string().optional()}).optional()},e=>d(void 0,null,function*(){var a,c,u,l;if(((a=e.request)==null?void 0:a.method)!=="POST"||(c=e.context.options.advanced)!=null&&c.disableCSRFCheck)return;let t=new URL(e.request.url);if(t.origin===new URL(e.context.baseURL).origin||(u=e.context.options.trustedOrigins)!=null&&u.includes(t.origin))return;let n=(l=e.body)==null?void 0:l.csrfToken,o=yield e.getSignedCookie(e.context.authCookies.csrfToken.name,e.context.secret),[r,i]=(o==null?void 0:o.split("!"))||[null,null];if(!n||!o||!r||!i||o!==n)throw e.setCookie(e.context.authCookies.csrfToken.name,"",{maxAge:0}),new Re("UNAUTHORIZED",{message:"Invalid CSRF Token"});let s=yield J(e.context.secret,r);if(i!==s)throw e.setCookie(e.context.authCookies.csrfToken.name,"",{maxAge:0}),new Re("UNAUTHORIZED",{message:"Invalid CSRF Token"})}));import{APIError as D}from"better-call";import{generateCodeVerifier as Yt}from"oslo/oauth2";import{z as I}from"zod";import"arctic";import{parseJWT as Ct}from"oslo/jwt";import"@better-fetch/fetch";var v=class extends Error{constructor(t,n,o){super(t),this.name="BetterAuthError",this.message=t,this.cause=n}};import{OAuth2Tokens as _t}from"arctic";function Ot(e){try{return new URL(e).pathname!=="/"}catch(t){throw new v(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function oe(e,t="/api/auth"){return Ot(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function Q(e,t){if(e)return oe(e,t);let n=(process==null?void 0:process.env)||{},o=n.BETTER_AUTH_URL||n.NEXT_PUBLIC_BETTER_AUTH_URL||n.PUBLIC_BETTER_AUTH_URL||n.NUXT_PUBLIC_BETTER_AUTH_URL||n.NUXT_PUBLIC_AUTH_URL||(n.BASE_URL!=="/"?n.BASE_URL:void 0);if(o)return oe(o,t);if(typeof window!="undefined")return oe(window.location.origin,t)}import{betterFetch as Et}from"@better-fetch/fetch";function A(e,t){return t||`${Q()}/callback/${e}`}function x(i){return d(this,arguments,function*({code:e,codeVerifier:t,redirectURI:n,options:o,tokenEndpoint:r}){let s=new URLSearchParams;s.set("grant_type","authorization_code"),s.set("code",e),t&&s.set("code_verifier",t),s.set("redirect_uri",n),s.set("client_id",o.clientId),s.set("client_secret",o.clientSecret);let{data:a,error:c}=yield Et(r,{method:"POST",body:s,headers:{"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"}});if(c)throw c;return new _t(a)})}var Ue=e=>{let t="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:o,scopes:r,redirectURI:i}){let s=r||["email","name","openid"];return new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${i||e.redirectURI}&scope=${s.join(" ")}&state=${o}`)},validateAuthorizationCode:(o,r,i)=>d(void 0,null,function*(){return x({code:o,codeVerifier:r,redirectURI:i||A("apple",e.redirectURI),options:e,tokenEndpoint:t})}),getUserInfo(o){return d(this,null,function*(){var i;let r=(i=Ct(o.idToken()))==null?void 0:i.payload;return r?{user:{id:r.sub,name:r.name,email:r.email,emailVerified:r.email_verified==="true"},data:r}:null})}}};import{betterFetch as Bt}from"@better-fetch/fetch";import{Discord as Dt}from"arctic";var Pe=e=>{let t=new Dt(e.clientId,e.clientSecret,A("discord",e.redirectURI));return{id:"discord",name:"Discord",createAuthorizationURL({state:o,scopes:r}){let i=r||["email"];return t.createAuthorizationURL(o,i)},validateAuthorizationCode:(o,r,i)=>d(void 0,null,function*(){return x({code:o,codeVerifier:r,redirectURI:i||A("discord",e.redirectURI),options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"})}),getUserInfo(o){return d(this,null,function*(){let{data:r,error:i}=yield Bt("https://discord.com/api/users/@me",{auth:{type:"Bearer",token:o.accessToken()}});return i?null:{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified},data:r}})}}};import{betterFetch as jt}from"@better-fetch/fetch";import{Facebook as qt}from"arctic";var ve=e=>{let t=new qt(e.clientId,e.clientSecret,A("facebook",e.redirectURI));return{id:"facebook",name:"Facebook",createAuthorizationURL({state:o,scopes:r}){let i=r||["email","public_profile"];return t.createAuthorizationURL(o,i)},validateAuthorizationCode:(o,r,i)=>d(void 0,null,function*(){return x({code:o,codeVerifier:r,redirectURI:i||A("facebook",e.redirectURI),options:e,tokenEndpoint:"https://graph.facebook.com/v16.0/oauth/access_token"})}),getUserInfo(o){return d(this,null,function*(){let{data:r,error:i}=yield jt("https://graph.facebook.com/me",{auth:{type:"Bearer",token:o.accessToken()}});return i?null:{user:{id:r.id,name:r.name,email:r.email,emailVerified:r.email_verified},data:r}})}}};import{betterFetch as Ie}from"@better-fetch/fetch";import{GitHub as Nt}from"arctic";var Se=({clientId:e,clientSecret:t,redirectURI:n})=>{let o=new Nt(e,t,A("github",n));return{id:"github",name:"Github",createAuthorizationURL({state:i,scopes:s}){let a=s||["user:email"];return o.createAuthorizationURL(i,a)},validateAuthorizationCode:i=>d(void 0,null,function*(){return yield o.validateAuthorizationCode(i)}),getUserInfo(i){return d(this,null,function*(){var u,l,p,m;let{data:s,error:a}=yield Ie("https://api.github.com/user",{auth:{type:"Bearer",token:i.accessToken()}});if(a)return null;let c=!1;if(!s.email){let{data:g,error:T}=yield Ie("https://api.github.com/user/emails",{auth:{type:"Bearer",token:i.accessToken()}});T||(s.email=(l=(u=g.find(k=>k.primary))!=null?u:g[0])==null?void 0:l.email,c=(m=(p=g.find(k=>k.email===s.email))==null?void 0:p.verified)!=null?m:!1)}return{user:{id:s.id,name:s.name,email:s.email,image:s.avatar_url,emailVerified:c,createdAt:new Date,updatedAt:new Date},data:s}})}}};import{Google as Ft}from"arctic";import{parseJWT as zt}from"oslo/jwt";import{createConsola as $t}from"consola";var N=$t({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),ne=e=>({log:(...t)=>{!(e!=null&&e.disabled)&&N.log("",...t)},error:(...t)=>{!(e!=null&&e.disabled)&&N.error("",...t)},warn:(...t)=>{!(e!=null&&e.disabled)&&N.warn("",...t)},info:(...t)=>{!(e!=null&&e.disabled)&&N.info("",...t)},debug:(...t)=>{!(e!=null&&e.disabled)&&N.debug("",...t)},box:(...t)=>{!(e!=null&&e.disabled)&&N.box("",...t)},success:(...t)=>{!(e!=null&&e.disabled)&&N.success("",...t)},break:(...t)=>{!(e!=null&&e.disabled)&&console.log(`
`)}}),L=ne();var Le=e=>{let t=new Ft(e.clientId,e.clientSecret,A("google",e.redirectURI));return{id:"google",name:"Google",createAuthorizationURL({state:o,scopes:r,codeVerifier:i,redirectURI:s}){if(!e.clientId||!e.clientSecret)throw L.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new v("CLIENT_ID_AND_SECRET_REQUIRED");if(!i)throw new v("codeVerifier is required for Google");let a=r||["email","profile"];return t.createAuthorizationURL(o,i,a)},validateAuthorizationCode:(o,r,i)=>d(void 0,null,function*(){return x({code:o,codeVerifier:r,redirectURI:i||A("google",e.redirectURI),options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"})}),getUserInfo(o){return d(this,null,function*(){var i;if(!o.idToken)return null;let r=(i=zt(o.idToken()))==null?void 0:i.payload;return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified},data:r}})}}};import{betterFetch as Vt}from"@better-fetch/fetch";import{Spotify as Mt}from"arctic";var Oe=e=>{let t=new Mt(e.clientId,e.clientSecret,A("spotify",e.redirectURI));return{id:"spotify",name:"Spotify",createAuthorizationURL({state:o,scopes:r}){let i=r||["user-read-email"];return t.createAuthorizationURL(o,i)},validateAuthorizationCode:(o,r,i)=>d(void 0,null,function*(){return x({code:o,codeVerifier:r,redirectURI:i||A("spotify",e.redirectURI),options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"})}),getUserInfo(o){return d(this,null,function*(){var s;let{data:r,error:i}=yield Vt("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken()}`}});return i?null:{user:{id:r.id,name:r.display_name,email:r.email,image:(s=r.images[0])==null?void 0:s.url,emailVerified:!1},data:r}})}}};import{betterFetch as Ht}from"@better-fetch/fetch";import{Twitch as Gt}from"arctic";var _e=e=>{let t=new Gt(e.clientId,e.clientSecret,A("twitch",e.redirectURI));return{id:"twitch",name:"Twitch",createAuthorizationURL({state:o,scopes:r}){let i=r||["activity:write","read"];return t.createAuthorizationURL(o,i)},validateAuthorizationCode:(o,r,i)=>d(void 0,null,function*(){return x({code:o,codeVerifier:r,redirectURI:i||A("twitch",e.redirectURI),options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"})}),getUserInfo(o){return d(this,null,function*(){let{data:r,error:i}=yield Ht("https://api.twitch.tv/helix/users",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken()}`}});return i?null:{user:{id:r.sub,name:r.preferred_username,email:r.email,image:r.picture,emailVerified:!1},data:r}})}}};import{betterFetch as Kt}from"@better-fetch/fetch";import{Twitter as Wt}from"arctic";var Ee=e=>{let t=new Wt(e.clientId,e.clientSecret,A("twitter",e.redirectURI));return{id:"twitter",name:"Twitter",createAuthorizationURL(o){let r=o.scopes||["account_info.read"];return t.createAuthorizationURL(o.state,o.codeVerifier,r)},validateAuthorizationCode:(o,r,i)=>d(void 0,null,function*(){return x({code:o,codeVerifier:r,redirectURI:i||A("twitch",e.redirectURI),options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"})}),getUserInfo(o){return d(this,null,function*(){let{data:r,error:i}=yield Kt("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken()}`}});return i||!r.data.email?null:{user:{id:r.data.id,name:r.data.name,email:r.data.email,image:r.data.profile_image_url,emailVerified:r.data.verified||!1},data:r}})}}};import"arctic";var se={apple:Ue,discord:Pe,facebook:ve,github:Se,google:Le,spotify:Oe,twitch:_e,twitter:Ee},Ce=Object.keys(se);import{generateState as Jt}from"oslo/oauth2";import{z as M}from"zod";function Be(e,t,n){let o=Jt();return{state:JSON.stringify({code:o,callbackURL:e,currentURL:t,dontRememberMe:n}),code:o}}function ie(e){return M.object({code:M.string(),callbackURL:M.string().optional(),currentURL:M.string().optional(),dontRememberMe:M.boolean().optional()}).safeParse(JSON.parse(e))}import{APIError as Qt}from"better-call";var H=(e,t=!1)=>{let n=new Date;return new Date(n.getTime()+(t?e*1e3:e))};import{TimeSpan as Zt}from"oslo";function De(e){var i;let n=!!((i=e.advanced)!=null&&i.useSecureCookies)||process.env.NODE_ENV!=="development"&&process.env.NODE_ENV!=="test"?"__Secure-":"",o="better-auth",r=new Zt(7,"d").seconds();return{sessionToken:{name:`${n}${o}.session_token`,options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!!n,maxAge:r}},csrfToken:{name:`${n?"__Host-":""}${o}.csrf_token`,options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!!n,maxAge:60*60*24*7}},state:{name:`${n}${o}.state`,options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!!n,maxAge:60*15}},pkCodeVerifier:{name:`${n}${o}.pk_code_verifier`,options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!!n,maxAge:60*15}},dontRememberToken:{name:`${n}${o}.dont_remember`,options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!!n}},nonce:{name:`${n}${o}.nonce`,options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!!n,maxAge:60*15}}}}function je(e){var i;let n=!!((i=e.advanced)!=null&&i.useSecureCookies)||process.env.NODE_ENV==="production"?"__Secure-":"",o="better-auth";function r(s,a){return{name:process.env.NODE_ENV==="production"?`${n}${o}.${s}`:`${o}.${s}`,options:f({secure:!!n,sameSite:"lax",path:"/",maxAge:60*15},a)}}return r}function _(e,t,n,o){return d(this,null,function*(){let r=e.context.authCookies.sessionToken.options;r.maxAge=n?void 0:r.maxAge,yield e.setSignedCookie(e.context.authCookies.sessionToken.name,t,e.context.secret,r),n&&(yield e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options))})}function G(e){e.setCookie(e.context.authCookies.sessionToken.name,"",{maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{maxAge:0})}import{z as qe}from"zod";function X(e){let t="127.0.0.1";if(process.env.NODE_ENV==="test")return t;let n=["x-client-ip","x-forwarded-for","cf-connecting-ip","fastly-client-ip","x-real-ip","x-cluster-client-ip","x-forwarded","forwarded-for","forwarded"];for(let o of n){let r=e.headers.get(o);if(typeof r=="string"){let i=r.split(",")[0].trim();if(i)return i}}return null}var ae=new Map;function Xt(e,t){if(!e.request)return"";let{method:n,url:o,headers:r}=e.request,i=e.request.headers.get("User-Agent")||"",s=X(e.request)||"",a=JSON.stringify(r);return`${n}:${o}:${a}:${i}:${s}:${t}`}var de=()=>h("/session",{method:"GET",requireHeaders:!0},e=>d(void 0,null,function*(){try{let t=yield e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)return e.json(null,{status:401});let n=Xt(e,t),o=ae.get(n);if(o){if(o.expiresAt>Date.now())return e.json(o.data);ae.delete(n)}let r=yield e.context.internalAdapter.findSession(t);if(!r||r.session.expiresAt<new Date)return G(e),r&&(yield e.context.internalAdapter.deleteSession(r.session.id)),e.json(null,{status:401});if(yield e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret))return e.json(r);let s=e.context.sessionConfig.expiresIn,a=e.context.sessionConfig.updateAge;if(r.session.expiresAt.valueOf()-s*1e3+a*1e3<=Date.now()){let l=yield e.context.internalAdapter.updateSession(r.session.id,{expiresAt:H(e.context.sessionConfig.expiresIn,!0)});if(!l)return G(e),e.json(null,{status:401});let p=(l.expiresAt.valueOf()-Date.now())/1e3;return yield _(e,l.id,!1,{maxAge:p}),e.json({session:l,user:r.user})}return ae.set(n,{data:r,expiresAt:Date.now()+5e3}),e.json(r)}catch(t){return e.context.logger.error(t),e.json(null,{status:500})}})),ce=e=>d(void 0,null,function*(){return yield de()(w(f({},e),{_flag:void 0}))}),$=Z(e=>d(void 0,null,function*(){let t=yield ce(e);if(!(t!=null&&t.session))throw new Qt("UNAUTHORIZED");return{session:t}})),Ne=()=>h("/user/list-sessions",{method:"GET",use:[$],requireHeaders:!0},e=>d(void 0,null,function*(){let n=(yield e.context.adapter.findMany({model:e.context.tables.session.tableName,where:[{field:"userId",value:e.context.session.user.id}]})).filter(o=>o.expiresAt>new Date);return e.json(n)})),$e=h("/user/revoke-session",{method:"POST",body:qe.object({id:qe.string()}),use:[$],requireHeaders:!0},e=>d(void 0,null,function*(){let t=e.body.id,n=yield e.context.internalAdapter.findSession(t);if(!n)return e.json(null,{status:400});if(n.session.userId!==e.context.session.user.id)return e.json(null,{status:403});try{yield e.context.internalAdapter.deleteSession(t)}catch(o){return e.context.logger.error(o),e.json(null,{status:500})}return e.json({status:!0})})),Fe=h("/user/revoke-sessions",{method:"POST",use:[$],requireHeaders:!0},e=>d(void 0,null,function*(){try{yield e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(t){return e.context.logger.error(t),e.json(null,{status:500})}return e.json({status:!0})}));var ze=h("/sign-in/social",{method:"POST",requireHeaders:!0,query:I.object({currentURL:I.string().optional()}).optional(),body:I.object({callbackURL:I.string().optional(),provider:I.enum(Ce),dontRememberMe:I.boolean().default(!1).optional()})},e=>d(void 0,null,function*(){var s,a,c,u;let t=e.context.socialProviders.find(l=>l.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider to your auth config",{provider:e.body.provider}),new D("NOT_FOUND",{message:"Provider not found"});let n=e.context.authCookies,o=(s=e.query)!=null&&s.currentURL?new URL((a=e.query)==null?void 0:a.currentURL):null,r=(c=e.body.callbackURL)!=null&&c.startsWith("http")?e.body.callbackURL:`${o==null?void 0:o.origin}${e.body.callbackURL||""}`,i=Be(r||(o==null?void 0:o.origin)||e.context.baseURL,(u=e.query)==null?void 0:u.currentURL);try{yield e.setSignedCookie(n.state.name,i.code,e.context.secret,n.state.options);let l=Yt();yield e.setSignedCookie(n.pkCodeVerifier.name,l,e.context.secret,n.pkCodeVerifier.options);let p=t.createAuthorizationURL({state:i.state,codeVerifier:l});return p.searchParams.set("redirect_uri",`${e.context.baseURL}/callback/${e.body.provider}`),{url:p.toString(),state:i.state,codeVerifier:l,redirect:!0}}catch(l){throw new D("INTERNAL_SERVER_ERROR")}})),Ve=h("/sign-in/email",{method:"POST",body:I.object({email:I.string().email(),password:I.string(),callbackURL:I.string().optional(),dontRememberMe:I.boolean().default(!1).optional()})},e=>d(void 0,null,function*(){var l,p;if(!((p=(l=e.context.options)==null?void 0:l.emailAndPassword)!=null&&p.enabled))throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new D("BAD_REQUEST",{message:"Email and password is not enabled"});let t=yield ce(e);t&&(yield e.context.internalAdapter.deleteSession(t.session.id));let{email:n,password:o}=e.body;if(!I.string().email().safeParse(n).success)throw new D("BAD_REQUEST",{message:"Invalid email"});let i=yield e.context.internalAdapter.findUserByEmail(n);if(!i)throw yield e.context.password.hash(o),e.context.logger.error("User not found",{email:n}),new D("UNAUTHORIZED",{message:"Invalid email or password"});let s=i.accounts.find(m=>m.providerId==="credential");if(!s)throw e.context.logger.error("Credential account not found",{email:n}),new D("UNAUTHORIZED",{message:"Invalid email or password"});let a=s==null?void 0:s.password;if(!a)throw e.context.logger.error("Password not found",{email:n}),new D("UNAUTHORIZED",{message:"Unexpected error"});if(!(yield e.context.password.verify(a,o)))throw e.context.logger.error("Invalid password"),new D("UNAUTHORIZED",{message:"Invalid email or password"});let u=yield e.context.internalAdapter.createSession(i.user.id,e.headers,e.body.dontRememberMe);return yield _(e,u.id,e.body.dontRememberMe),e.json({user:i.user,session:u,redirect:!!e.body.callbackURL,url:e.body.callbackURL})}));import{APIError as rr}from"better-call";import{z as Y}from"zod";import{z as y}from"zod";var ts=y.object({id:y.string(),providerId:y.string(),accountId:y.string(),userId:y.string(),accessToken:y.string().nullable().optional(),refreshToken:y.string().nullable().optional(),idToken:y.string().nullable().optional(),expiresAt:y.date().nullable().optional(),password:y.string().optional().nullable()}),Me=y.object({id:y.string(),email:y.string().transform(e=>e.toLowerCase()),emailVerified:y.boolean().default(!1),name:y.string(),image:y.string().optional(),createdAt:y.date().default(new Date),updatedAt:y.date().default(new Date)}),rs=y.object({id:y.string(),userId:y.string(),expiresAt:y.date(),ipAddress:y.string().optional(),userAgent:y.string().optional()});import{alphabet as er,generateRandomString as tr}from"oslo/crypto";var He=()=>tr(36,er("a-z","0-9"));var j={isAction:!1};function le(e){let t=e.accessToken(),n=e.hasRefreshToken()?e.refreshToken():void 0,o;try{o=e.accessTokenExpiresAt()}catch(r){}return{accessToken:t,refreshToken:n,expiresAt:o}}var Ge=h("/callback/:id",{method:"GET",query:Y.object({state:Y.string(),code:Y.string().optional(),error:Y.string().optional()}),metadata:j},e=>d(void 0,null,function*(){var T,k,U;if(e.query.error||!e.query.code){let R=((T=ie(e.query.state).data)==null?void 0:T.callbackURL)||`${e.context.baseURL}/error`;throw e.context.logger.error(e.query.error,e.params.id),e.redirect(`${R}?error=${e.query.error||"oAuth_code_missing"}`)}let t=e.context.socialProviders.find(b=>b.id===e.params.id);if(!t)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),e.redirect(`${e.context.baseURL}/error?error=oauth_provider_not_found`);let n=yield e.getSignedCookie(e.context.authCookies.pkCodeVerifier.name,e.context.secret),o;try{o=yield t.validateAuthorizationCode(e.query.code,n,`${e.context.baseURL}/callback/${t.id}`)}catch(b){throw e.context.logger.error(b),e.redirect(`${e.context.baseURL}/error?error=oauth_code_verification_failed`)}let r=yield t.getUserInfo(o).then(b=>b==null?void 0:b.user),i=He(),s=Me.safeParse(w(f({},r),{id:i})),a=ie(e.query.state);if(!a.success)throw e.context.logger.error("Unable to parse state"),e.redirect(`${e.context.baseURL}/error?error=invalid_state_parameter`);let{callbackURL:c,currentURL:u,dontRememberMe:l}=a.data;if(!r||s.success===!1)throw e.redirect(`${e.context.baseURL}/error?error=oauth_validation_failed`);if(!c)throw e.redirect(`${e.context.baseURL}/error?error=oauth_callback_url_not_found`);let p=yield e.context.internalAdapter.findUserByEmail(r.email),m=p==null?void 0:p.user.id;if(p){let b=p.accounts.find(O=>O.providerId===t.id),R=(U=(k=e.context.options.account)==null?void 0:k.accountLinking)==null?void 0:U.trustedProviders,P=R?R.includes(t.id):!0,q=!b&&r.emailVerified&&P;if(!q){let O;try{O=new URL(u||c),O.searchParams.set("error","account_not_linked")}catch(F){throw e.redirect(`${e.context.baseURL}/error?error=account_not_linked`)}throw e.redirect(O.toString())}if(q)try{yield e.context.internalAdapter.linkAccount(f({providerId:t.id,accountId:r.id,id:`${t.id}:${r.id}`,userId:p.user.id},le(o)))}catch(O){throw console.log(O),e.redirect(`${e.context.baseURL}/error?error=failed_linking_account`)}}else try{yield e.context.internalAdapter.createOAuthUser(s.data,w(f({},le(o)),{id:`${t.id}:${r.id}`,providerId:t.id,accountId:r.id,userId:i}))}catch(b){let R=new URL(u||c);throw R.searchParams.set("error","unable_to_create_user"),e.setHeader("Location",R.toString()),e.redirect(R.toString())}if(!m&&!i)throw new rr("INTERNAL_SERVER_ERROR",{message:"Unable to create user"});let g=yield e.context.internalAdapter.createSession(m||i,e.request,l);try{yield _(e,g.id,l)}catch(b){e.context.logger.error("Unable to set session cookie",b);let R=new URL(u||c);throw R.searchParams.set("error","unable_to_create_session"),e.redirect(R.toString())}throw e.redirect(c)}));import{z as ue}from"zod";var Ke=h("/sign-out",{method:"POST",body:ue.optional(ue.object({callbackURL:ue.string().optional()}))},e=>d(void 0,null,function*(){var n,o;let t=yield e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);return t?(yield e.context.internalAdapter.deleteSession(t),G(e),e.json(null,{body:{redirect:!!((n=e.body)!=null&&n.callbackURL),url:(o=e.body)==null?void 0:o.callbackURL}})):e.json(null)}));import{TimeSpan as or}from"oslo";import{createJWT as nr,parseJWT as sr}from"oslo/jwt";import{validateJWT as We}from"oslo/jwt";import{z as S}from"zod";var Je=h("/forget-password",{method:"POST",body:S.object({email:S.string().email(),redirectTo:S.string()})},e=>d(void 0,null,function*(){var i;if(!((i=e.context.options.emailAndPassword)!=null&&i.sendResetPassword))return e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPasswordToken function to your auth config!"),e.json(null,{status:400,statusText:"RESET_PASSWORD_EMAIL_NOT_SENT",body:{message:"Reset password isn't enabled"}});let{email:t}=e.body,n=yield e.context.internalAdapter.findUserByEmail(t);if(!n)return e.json({status:!1},{body:{status:!0}});let o=yield nr("HS256",Buffer.from(e.context.secret),{email:n.user.email,redirectTo:e.body.redirectTo},{expiresIn:new or(1,"h"),issuer:"better-auth",subject:"forget-password",audiences:[n.user.email],includeIssuedTimestamp:!0}),r=`${e.context.baseURL}/reset-password/${o}`;return yield e.context.options.emailAndPassword.sendResetPassword(r,n.user),e.json({status:!0})})),Ze=h("/reset-password/:token",{method:"GET"},e=>d(void 0,null,function*(){var i;let{token:t}=e.params,n,o=S.object({email:S.string(),redirectTo:S.string()});try{if(n=yield We("HS256",Buffer.from(e.context.secret),t),!n.expiresAt||n.expiresAt<new Date)throw Error("Token expired")}catch(s){let a=sr(t),c=o.safeParse(a==null?void 0:a.payload);throw c.success?e.redirect(`${(i=c.data)==null?void 0:i.redirectTo}?error=invalid_token`):e.redirect(`${e.context.baseURL}/error?error=invalid_token`)}let{redirectTo:r}=o.parse(n.payload);throw e.redirect(`${r}?token=${t}`)})),Qe=h("/reset-password",{method:"POST",query:S.object({currentURL:S.string()}).optional(),body:S.object({newPassword:S.string(),callbackURL:S.string().optional()})},e=>d(void 0,null,function*(){var o,r,i;let t=(o=e.query)==null?void 0:o.currentURL.split("?token=")[1];if(!t)return e.json({error:"Invalid token",data:null},{status:400,statusText:"INVALID_TOKEN",body:{message:"Invalid token"}});let{newPassword:n}=e.body;try{let s=yield We("HS256",Buffer.from(e.context.secret),t),a=S.string().email().parse(s.payload.email),c=yield e.context.internalAdapter.findUserByEmail(a);if(!c)return e.json({error:"User not found",data:null},{status:400,body:{message:"failed to reset password"}});if(n.length<(((r=e.context.options.emailAndPassword)==null?void 0:r.minPasswordLength)||8)||n.length>(((i=e.context.options.emailAndPassword)==null?void 0:i.maxPasswordLength)||32))return e.json({data:null,error:"password is too short or too long"},{status:400,statusText:"INVALID_PASSWORD_LENGTH",body:{message:"password is too short or too long"}});let u=yield e.context.password.hash(n);return(yield e.context.internalAdapter.updatePassword(c.user.id,u))?e.json({error:null,data:{status:!0,url:e.body.callbackURL,redirect:!!e.body.callbackURL}},{body:{status:!0,url:e.body.callbackURL,redirect:!!e.body.callbackURL}}):e.json(null,{status:400,statusText:"USER_NOT_FOUND",body:{message:"User doesn't have a credential account"}})}catch(s){return console.log(s),e.json({error:"Invalid token",data:null},{status:400,statusText:"INVALID_TOKEN",body:{message:"Invalid token"}})}}));import{TimeSpan as ir}from"oslo";import{createJWT as ar,validateJWT as dr}from"oslo/jwt";import{z as E}from"zod";function pe(e,t){return d(this,null,function*(){return yield ar("HS256",Buffer.from(e),{email:t.toLowerCase()},{expiresIn:new ir(1,"h"),issuer:"better-auth",subject:"verify-email",audiences:[t],includeIssuedTimestamp:!0})})}var Xe=h("/send-verification-email",{method:"POST",query:E.object({currentURL:E.string().optional()}).optional(),body:E.object({email:E.string().email(),callbackURL:E.string().optional()})},e=>d(void 0,null,function*(){var r,i;if(!((r=e.context.options.emailAndPassword)!=null&&r.sendVerificationEmail))return e.context.logger.error("Verification email isn't enabled. Pass `sendVerificationEmail` in `emailAndPassword` options to enable it."),e.json(null,{status:400,statusText:"VERIFICATION_EMAIL_NOT_SENT",body:{message:"Verification email isn't enabled"}});let{email:t}=e.body,n=yield pe(e.context.secret,t),o=`${e.context.baseURL}/verify-email?token=${n}&callbackURL=${e.body.callbackURL||((i=e.query)==null?void 0:i.currentURL)||"/"}`;return yield e.context.options.emailAndPassword.sendVerificationEmail(t,o,n),e.json({status:!0})})),Ye=h("/verify-email",{method:"GET",query:E.object({token:E.string(),callbackURL:E.string().optional()})},e=>d(void 0,null,function*(){let{token:t}=e.query,n;try{n=yield dr("HS256",Buffer.from(e.context.secret),t)}catch(a){return e.context.logger.error("Failed to verify email",a),e.json(null,{status:400,statusText:"INVALID_TOKEN",body:{message:"Invalid token"}})}let r=E.object({email:E.string().email()}).parse(n.payload),i=yield e.context.internalAdapter.findUserByEmail(r.email);if(!i)return e.json(null,{status:400,statusText:"USER_NOT_FOUND",body:{message:"User not found"}});if(!i.accounts.find(a=>a.providerId==="credential"))throw e.redirect;if(yield e.context.internalAdapter.updateUserByEmail(r.email,{emailVerified:!0}),e.query.callbackURL)throw console.log("Redirecting to",e.query.callbackURL),e.redirect("/");return e.json({status:!0})}));import{z as C}from"zod";import{alphabet as cr,generateRandomString as lr}from"oslo/crypto";import"better-call";var et=h("/user/update",{method:"POST",body:C.object({name:C.string().optional(),image:C.string().optional()}),use:[$]},e=>d(void 0,null,function*(){let{name:t,image:n}=e.body,o=e.context.session;if(!n&&!t)return e.json(o.user);let r=yield e.context.internalAdapter.updateUserByEmail(o.user.email,{name:t,image:n});return e.json(r)})),tt=h("/user/change-password",{method:"POST",body:C.object({newPassword:C.string(),currentPassword:C.string(),revokeOtherSessions:C.boolean().optional()}),use:[$]},e=>d(void 0,null,function*(){let{newPassword:t,currentPassword:n,revokeOtherSessions:o}=e.body,r=e.context.session,i=e.context.password.config.minPasswordLength;if(t.length<i)return e.context.logger.error("Password is too short"),e.json(null,{status:400,body:{message:"Password is too short"}});let s=e.context.password.config.maxPasswordLength;if(t.length>s)return e.context.logger.error("Password is too long"),e.json(null,{status:400,body:{message:"Password is too long"}});let c=(yield e.context.internalAdapter.findAccounts(r.user.id)).find(p=>p.providerId==="credential"&&p.password);if(!c||!c.password)return e.json(null,{status:400,body:{message:"User does not have a password"}});let u=yield e.context.password.hash(t);if(!(yield e.context.password.verify(c.password,n)))return e.json(null,{status:400,body:{message:"Invalid password"}});if(yield e.context.internalAdapter.updateAccount(c.id,{password:u}),o){yield e.context.internalAdapter.deleteSessions(r.user.id);let p=yield e.context.internalAdapter.createSession(r.user.id,e.headers);yield _(e,p.id)}return e.json(r.user)})),rt=h("/user/set-password",{method:"POST",body:C.object({newPassword:C.string()}),use:[$]},e=>d(void 0,null,function*(){let{newPassword:t}=e.body,n=e.context.session,o=e.context.password.config.minPasswordLength;if(t.length<o)return e.context.logger.error("Password is too short"),e.json(null,{status:400,body:{message:"Password is too short"}});let r=e.context.password.config.maxPasswordLength;if(t.length>r)return e.context.logger.error("Password is too long"),e.json(null,{status:400,body:{message:"Password is too long"}});let s=(yield e.context.internalAdapter.findAccounts(n.user.id)).find(c=>c.providerId==="credential"&&c.password),a=yield e.context.password.hash(t);return s?e.json(null,{status:400,body:{message:"User already has a password"}}):(yield e.context.internalAdapter.linkAccount({id:lr(32,cr("a-z","0-9","A-Z")),userId:n.user.id,providerId:"credential",accountId:n.user.id,password:a}),e.json(n.user))}));import{alphabet as ur,generateRandomString as pr}from"oslo/crypto";var ot=h("/csrf",{method:"GET",metadata:j},e=>d(void 0,null,function*(){let t=yield e.getSignedCookie(e.context.authCookies.csrfToken.name,e.context.secret);if(t)return{csrfToken:t};let n=pr(32,ur("a-z","0-9","A-Z")),o=yield J(e.context.secret,n),r=`${n}!${o}`;return yield e.setSignedCookie(e.context.authCookies.csrfToken.name,r,e.context.secret,e.context.authCookies.csrfToken.options),{csrfToken:n}}));var mr=(e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon">\u26A0\uFE0F</div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${e}</span></div>
    </div>
</body>
</html>`,nt=h("/error",{method:"GET",metadata:j},e=>d(void 0,null,function*(){var n;let t=new URL(((n=e.request)==null?void 0:n.url)||"").searchParams.get("error")||"Unknown";return new Response(mr(t),{headers:{"Content-Type":"text/html"}})}));var st=h("/ok",{method:"GET",metadata:j},e=>d(void 0,null,function*(){return e.json({ok:!0})}));import{alphabet as it,generateRandomString as at}from"oslo/crypto";import{z as B}from"zod";var dt=h("/sign-up/email",{method:"POST",query:B.object({currentURL:B.string().optional()}).optional(),body:B.object({name:B.string(),email:B.string(),password:B.string(),image:B.string().optional(),callbackURL:B.string().optional()})},e=>d(void 0,null,function*(){var m,g,T,k;if(!((m=e.context.options.emailAndPassword)!=null&&m.enabled))return e.json(null,{status:400,body:{message:"Email and password is not enabled"}});let{name:t,email:n,password:o,image:r}=e.body;if(!B.string().email().safeParse(n).success)return e.json(null,{status:400,body:{message:"Invalid email address"}});let s=e.context.password.config.minPasswordLength;if(o.length<s)return e.context.logger.error("Password is too short"),e.json(null,{status:400,body:{message:"Password is too short"}});let a=e.context.password.config.maxPasswordLength;if(o.length>a)return e.context.logger.error("Password is too long"),e.json(null,{status:400,body:{message:"Password is too long"}});let c=yield e.context.internalAdapter.findUserByEmail(n),u=yield e.context.password.hash(o);if(c!=null&&c.user)return e.json(null,{status:400,body:{message:"User already exists"}});let l=yield e.context.internalAdapter.createUser({id:at(32,it("a-z","0-9","A-Z")),email:n.toLowerCase(),name:t,image:r,emailVerified:!1,createdAt:new Date,updatedAt:new Date});yield e.context.internalAdapter.linkAccount({id:at(32,it("a-z","0-9","A-Z")),userId:l.id,providerId:"credential",accountId:l.id,password:u});let p=yield e.context.internalAdapter.createSession(l.id,e.request);if(yield _(e,p.id),e.context.options.emailAndPassword.sendEmailVerificationOnSignUp){let U=yield pe(e.context.secret,l.email),b=`${e.context.baseURL}/verify-email?token=${U}&callbackURL=${e.body.callbackURL||((g=e.query)==null?void 0:g.currentURL)||"/"}`;yield(k=(T=e.context.options.emailAndPassword).sendVerificationEmail)==null?void 0:k.call(T,l.email,b,U)}return e.json({user:l,session:p},{body:e.body.callbackURL?{url:e.body.callbackURL,redirect:!0}:{user:l,session:p}})}));import me from"chalk";function fr(e,t,n){let o=Date.now(),r=t*1e3;return o-n.lastRequest<r&&n.count>=e}function gr(e){return new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests",headers:{"X-Retry-After":e.toString()}})}function hr(e,t){let n=Date.now(),o=t*1e3;return Math.ceil((e+o-n)/1e3)}function yr(e,t){let n=t!=null?t:"rateLimit",o=e.adapter;return{get:r=>d(this,null,function*(){return yield o.findOne({model:n,where:[{field:"key",value:r}]})}),set:(r,i,s)=>d(this,null,function*(){try{s?yield o.update({model:t!=null?t:"rateLimit",where:[{field:"key",value:r}],update:{count:i.count,lastRequest:i.lastRequest}}):yield o.create({model:t!=null?t:"rateLimit",data:{key:r,count:i.count,lastRequest:i.lastRequest}})}catch(a){L.error("Error setting rate limit",a)}})}}var ct=new Map;function br(e){if(e.rateLimit.customStorage)return e.rateLimit.customStorage;if(e.rateLimit.storage==="memory"){let n;return{get(o){return d(this,null,function*(){return ct.get(o)})},set(o,r,i){return d(this,null,function*(){ct.set(o,r)})}}}return yr(e,e.rateLimit.tableName)}function lt(e,t){return d(this,null,function*(){if(!t.rateLimit.enabled)return;let n=t.baseURL,o=e.url.replace(n,""),r=t.rateLimit.window,i=t.rateLimit.max,s=X(e)+o,c=wr().find(m=>m.pathMatcher(o));c&&(r=c.window,i=c.max);for(let m of t.options.plugins||[])if(m.rateLimit){let g=m.rateLimit.find(T=>T.pathMatcher(o));if(g){r=g.window,i=g.max;break}}if(t.rateLimit.customRules){let m=t.rateLimit.customRules[o];m&&(r=m.window,i=m.max)}let u=br(t),l=yield u.get(s),p=Date.now();if(!l)yield u.set(s,{key:s,count:1,lastRequest:p});else{let m=p-l.lastRequest;if(fr(i,r,l)){let g=hr(l.lastRequest,r);return gr(g)}else m>r*1e3?yield u.set(s,w(f({},l),{count:1,lastRequest:p})):yield u.set(s,w(f({},l),{count:l.count+1,lastRequest:p}))}})}function wr(){return[{pathMatcher(t){return t.startsWith("/sign-in")||t.startsWith("/sign-up")},window:10,max:7}]}function fe(e,t){var a,c;let n=(a=e.options.plugins)==null?void 0:a.reduce((u,l)=>f(f({},u),l.endpoints),{}),o=((c=e.options.plugins)==null?void 0:c.map(u=>{var l;return(l=u.middlewares)==null?void 0:l.map(p=>{let m=g=>d(this,null,function*(){return p.middleware(w(f({},g),{context:f(f({},e),g.context)}))});return m.path=p.path,m.options=p.middleware.options,m.headers=p.middleware.headers,{path:p.path,middleware:m}})}).filter(u=>u!==void 0).flat())||[],r={signInOAuth:ze,callbackOAuth:Ge,getCSRFToken:ot,getSession:de(),signOut:Ke,signUpEmail:dt,signInEmail:Ve,forgetPassword:Je,resetPassword:Qe,verifyEmail:Ye,sendVerificationEmail:Xe,changePassword:tt,setPassword:rt,updateUser:et,forgetPasswordCallback:Ze,listSessions:Ne(),revokeSession:$e,revokeSessions:Fe},i=w(f(f({},r),n),{ok:st,error:nt}),s={};for(let[u,l]of Object.entries(i))s[u]=p=>d(this,null,function*(){var T;let g=yield l(w(f({},p),{context:f(f({},e),p.context)}));for(let k of e.options.plugins||[])if((T=k.hooks)!=null&&T.after){for(let U of k.hooks.after)if(U.matcher(p)){let R=Object.assign(p,{context:w(f({},e),{returned:g})}),P=yield U.handler(R);P&&"response"in P&&(g=P.response)}}return g}),s[u].path=l.path,s[u].method=l.method,s[u].options=l.options,s[u].headers=l.headers;return{api:s,middlewares:o}}var ut=(e,t)=>{let{api:n,middlewares:o}=fe(e,t),r=new URL(e.baseURL).pathname;return kr(n,{extraContext:e,basePath:r,routerMiddleware:[{path:"/**",middleware:xe},...o],onRequest(s){return d(this,null,function*(){return lt(s,e)})},onError(s){var c,u,l,p;let a=(c=t.logger)!=null&&c.verboseLogging?L:void 0;if(((u=t.logger)==null?void 0:u.disabled)!==!0)if(s instanceof Ar)a==null||a.warn(s);else if(typeof s=="object"&&s!==null&&"message"in s){let m=s.message;if(!m||typeof m!="string"){a==null||a.error(s);return}m.includes("no such table")?(l=L)==null||l.error(`Please run ${me.green("npx better-auth migrate")} to create the tables. There are missing tables in your SQLite database.`):m.includes("relation")&&m.includes("does not exist")?L.error(`Please run ${me.green("npx better-auth migrate")} to create the tables. There are missing tables in your PostgreSQL database.`):m.includes("Table")&&m.includes("doesn't exist")?(p=L)==null||p.error(`Please run ${me.green("npx better-auth migrate")} to create the tables. There are missing tables in your MySQL database.`):a==null||a.error(s)}else a==null||a.error(s)}})};var z=e=>{var c,u,l,m,g,T;let t=(c=e.plugins)==null?void 0:c.reduce((k,U)=>{var R;let b=U.schema;if(!b)return k;for(let[P,q]of Object.entries(b))k[P]={fields:f(f({},(R=k[P])==null?void 0:R.fields),q.fields),tableName:P};return k},{}),n=((u=e.rateLimit)==null?void 0:u.storage)==="database",o={rateLimit:{tableName:((l=e.rateLimit)==null?void 0:l.tableName)||"rateLimit",fields:{key:{type:"string"},count:{type:"number"},lastRequest:{type:"number"}}}},p=t||{},{user:r,session:i,account:s}=p,a=we(p,["user","session","account"]);return f(f({user:{tableName:((m=e.user)==null?void 0:m.modelName)||"user",fields:f({name:{type:"string"},email:{type:"string"},emailVerified:{type:"boolean",defaultValue:()=>!1},image:{type:"string",required:!1},createdAt:{type:"date",defaultValue:()=>new Date},updatedAt:{type:"date",defaultValue:()=>new Date}},r==null?void 0:r.fields),order:0},session:{tableName:((g=e.session)==null?void 0:g.modelName)||"session",fields:f({expiresAt:{type:"date"},ipAddress:{type:"string",required:!1},userAgent:{type:"string",required:!1},userId:{type:"string",references:{model:"user",field:"id",onDelete:"cascade"}}},i==null?void 0:i.fields),order:1},account:{tableName:((T=e.account)==null?void 0:T.modelName)||"account",fields:f({accountId:{type:"string"},providerId:{type:"string"},userId:{type:"string",references:{model:"user",field:"id",onDelete:"cascade"}},accessToken:{type:"string",required:!1},refreshToken:{type:"string",required:!1},idToken:{type:"string",required:!1},expiresAt:{type:"date",required:!1},password:{type:"string",required:!1}},s==null?void 0:s.fields),order:2}},a),n?o:{})};import Rr from"better-sqlite3";import{Kysely as Tr}from"kysely";import{MysqlDialect as mt,PostgresDialect as ft,SqliteDialect as gt}from"kysely";import{createPool as xr}from"mysql2";import Ur from"pg";var{Pool:Pr}=Ur;function ee(e){if(!e)return{and:null,or:null};let t=e==null?void 0:e.filter(o=>o.connector==="AND"||!o.connector).reduce((o,r)=>w(f({},o),{[r.field]:r.value}),{}),n=e==null?void 0:e.filter(o=>o.connector==="OR").reduce((o,r)=>w(f({},o),{[r.field]:r.value}),{});return{and:Object.keys(t).length?t:null,or:Object.keys(n).length?n:null}}function te(e,t,n){var o,r,i;for(let s in e)e[s]===0&&((o=t[s])==null?void 0:o.type)==="boolean"&&(n!=null&&n.boolean)&&(e[s]=!1),e[s]===1&&((r=t[s])==null?void 0:r.type)==="boolean"&&(n!=null&&n.boolean)&&(e[s]=!0),((i=t[s])==null?void 0:i.type)==="date"&&(e[s]instanceof Date||(e[s]=new Date(e[s])));return e}function pt(e,t){for(let n in e)typeof e[n]=="boolean"&&(t!=null&&t.boolean)&&(e[n]=e[n]?1:0),e[n]instanceof Date&&(e[n]=e[n].toISOString());return e}var ht=(e,t)=>({create(o){return d(this,null,function*(){let{model:r,data:i,select:s}=o;t!=null&&t.transform&&(i=pt(i,t.transform));let a=yield e.insertInto(r).values(i).returningAll().executeTakeFirst();if(t!=null&&t.transform){let c=t.transform.schema[r];a=c?te(i,c,t.transform):a}return s!=null&&s.length&&(a=a?s.reduce((u,l)=>a!=null&&a[l]?w(f({},u),{[l]:a[l]}):u,{}):null),a})},findOne(o){return d(this,null,function*(){let{model:r,where:i,select:s}=o,{and:a,or:c}=ee(i),u=e.selectFrom(r).selectAll();c&&(u=u.where(p=>p.or(c))),a&&(u=u.where(p=>p.and(a)));let l=yield u.executeTakeFirst();if(s!=null&&s.length&&(l=l?s.reduce((m,g)=>l!=null&&l[g]?w(f({},m),{[g]:l[g]}):m,{}):null),t!=null&&t.transform){let p=t.transform.schema[r];return l=l&&p?te(l,p,t.transform):l,l||null}return l||null})},findMany(o){return d(this,null,function*(){let{model:r,where:i}=o,s=e.selectFrom(r),{and:a,or:c}=ee(i);a&&(s=s.where(l=>l.and(a))),c&&(s=s.where(l=>l.or(c)));let u=yield s.selectAll().execute();if(t!=null&&t.transform){let l=t.transform.schema[r];return l?u.map(p=>te(p,l,t.transform)):u}return u})},update(o){return d(this,null,function*(){let{model:r,where:i,update:s}=o,{and:a,or:c}=ee(i);t!=null&&t.transform&&(s=pt(s,t.transform));let u=e.updateTable(r).set(s);a&&(u=u.where(p=>p.and(a))),c&&(u=u.where(p=>p.or(c)));let l=(yield u.returningAll().executeTakeFirst())||null;if(t!=null&&t.transform){let p=t.transform.schema[r];return p?te(l,p,t.transform):l}return l})},delete(o){return d(this,null,function*(){let{model:r,where:i}=o,{and:s,or:a}=ee(i),c=e.deleteFrom(r);s&&(c=c.where(u=>u.and(s))),a&&(c=c.where(u=>u.or(a))),yield c.execute()})}}),vr=e=>{var n,o;if(!e.database)return null;if("createDriver"in e.database)return e.database;let t=null;if("provider"in e.database){let r=e.database.provider,i=(o=(n=e.database)==null?void 0:n.url)==null?void 0:o.trim();if(r==="postgres"&&(t=new ft({pool:new Pr({connectionString:i})})),r==="mysql"){let s=new URL(i),a=xr({host:s.hostname,user:s.username,password:s.password,database:s.pathname.split("/")[1],port:Number(s.port)});t=new mt({pool:a})}if(r==="sqlite"){let s=new Rr(i);t=new gt({database:s})}}return t},re=e=>{let t=vr(e);return t?new Tr({dialect:t}):null},yt=e=>{if("provider"in e.database)return e.database.provider;if("dialect"in e.database){if(e.database.dialect instanceof ft)return"postgres";if(e.database.dialect instanceof mt)return"mysql";if(e.database.dialect instanceof gt)return"sqlite"}return"sqlite"};function bt(e){if(!e.database)throw new v("Database configuration is required");let t=re(e);if(!t)throw new v("Failed to initialize database adapter");let n=z(e),o={};for(let r of Object.values(n))o[r.tableName]=r.fields;return ht(t,{transform:{schema:o,date:!0,boolean:yt(e)==="sqlite"}})}import{scrypt as Ir}from"node:crypto";import{decodeHex as Sr,encodeHex as wt}from"oslo/encoding";import{constantTimeEqual as Lr}from"oslo/crypto";var V={N:16384,r:16,p:1,dkLen:64};function At(e,t){return d(this,null,function*(){return yield new Promise((n,o)=>{Ir(e.normalize("NFKC"),t,V.dkLen,{N:V.N,p:V.p,r:V.r,maxmem:128*V.N*V.r*2},(r,i)=>r?o(r):n(i))})})}var kt=e=>d(void 0,null,function*(){let t=wt(crypto.getRandomValues(new Uint8Array(16))),n=yield At(e,t);return`${t}:${wt(n)}`}),Rt=(e,t)=>d(void 0,null,function*(){let[n,o]=e.split(":"),r=yield At(t,n);return Lr(r,Sr(o))});import{alphabet as Or,generateRandomString as _r}from"oslo/crypto";var Tt=(e,t,n)=>{var i;let o=((i=n.session)==null?void 0:i.expiresIn)||604800,r=z(n);return{createOAuthUser:(s,a)=>d(void 0,null,function*(){try{let c=yield e.create({model:r.user.tableName,data:s}),u=yield e.create({model:r.account.tableName,data:a});return{user:c,account:u}}catch(c){return console.log(c),null}}),createUser:s=>d(void 0,null,function*(){return yield e.create({model:r.user.tableName,data:s})}),createSession:(s,a,c)=>d(void 0,null,function*(){let u=a instanceof Request?a.headers:a,l={id:_r(32,Or("a-z","0-9","A-Z")),userId:s,expiresAt:c?H(1e3*60*60*24):H(o,!0),ipAddress:(u==null?void 0:u.get("x-forwarded-for"))||"",userAgent:(u==null?void 0:u.get("user-agent"))||""};return e.create({model:r.session.tableName,data:l})}),findSession:s=>d(void 0,null,function*(){let a=yield e.findOne({model:r.session.tableName,where:[{value:s,field:"id"}]});if(!a)return null;let c=yield e.findOne({model:r.user.tableName,where:[{value:a.userId,field:"id"}]});return c?{session:a,user:c}:null}),updateSession:(s,a)=>d(void 0,null,function*(){return yield e.update({model:r.session.tableName,where:[{field:"id",value:s}],update:a})}),deleteSession:s=>d(void 0,null,function*(){return yield e.delete({model:r.session.tableName,where:[{field:"id",value:s}]})}),deleteSessions:s=>d(void 0,null,function*(){return yield t.deleteFrom(r.session.tableName).where("userId","=",s).execute()}),findUserByEmail:s=>d(void 0,null,function*(){let a=yield e.findOne({model:r.user.tableName,where:[{value:s.toLowerCase(),field:"email"}]});if(!a)return null;let c=yield e.findMany({model:r.account.tableName,where:[{value:a.id,field:"userId"}]});return{user:a,accounts:c}}),findUserById:s=>d(void 0,null,function*(){return yield e.findOne({model:r.user.tableName,where:[{field:"id",value:s}]})}),linkAccount:s=>d(void 0,null,function*(){return yield e.create({model:r.account.tableName,data:s})}),updateUserByEmail:(s,a)=>d(void 0,null,function*(){return yield e.update({model:r.user.tableName,where:[{value:s,field:"email"}],update:a})}),updatePassword:(s,a)=>d(void 0,null,function*(){return yield e.update({model:r.account.tableName,where:[{value:s,field:"userId"},{field:"providerId",value:"credential"}],update:{password:a}})}),findAccounts:s=>d(void 0,null,function*(){return yield e.findMany({model:r.account.tableName,where:[{field:"userId",value:s}]})}),updateAccount:(s,a)=>d(void 0,null,function*(){return yield e.update({model:r.account.tableName,where:[{field:"id",value:s}],update:a})})}};var xt="better-auth-secret-123456789";var Ut=e=>{var c,u,l,p,m,g,T,k,U,b,R,P,q,O;let t=bt(e),n=re(e);if(!n)throw new v("No database adapter found");let o=Q(e.baseURL,e.basePath)||"",r=e.secret||process.env.BETTER_AUTH_SECRET||process.env.AUTH_SECRET||xt,i=De(e),s=z(e),a=Object.keys(e.socialProviders||{}).map(F=>{var ge;let K=(ge=e.socialProviders)==null?void 0:ge[F];return K.enabled===!1?null:((!K.clientId||!K.clientSecret)&&L.warn(`Social provider ${F} is missing clientId or clientSecret`),se[F](K))}).filter(F=>F!==null);return{appName:e.appName||"Better Auth",socialProviders:a,options:w(f({},e),{baseURL:o?new URL(o).origin:"",basePath:e.basePath||"/api/auth"}),tables:s,baseURL:o,sessionConfig:{updateAge:((c=e.session)==null?void 0:c.updateAge)||24*60*60,expiresIn:((u=e.session)==null?void 0:u.expiresIn)||60*60*24*7},secret:r,rateLimit:w(f({},e.rateLimit),{enabled:(p=(l=e.rateLimit)==null?void 0:l.enabled)!=null?p:process.env.NODE_ENV!=="development",window:((m=e.rateLimit)==null?void 0:m.window)||60,max:((g=e.rateLimit)==null?void 0:g.max)||100,storage:((T=e.rateLimit)==null?void 0:T.storage)||"memory"}),authCookies:i,logger:ne({disabled:((k=e.logger)==null?void 0:k.disabled)||!1}),db:n,password:{hash:((b=(U=e.emailAndPassword)==null?void 0:U.password)==null?void 0:b.hash)||kt,verify:((P=(R=e.emailAndPassword)==null?void 0:R.password)==null?void 0:P.verify)||Rt,config:{minPasswordLength:((q=e.emailAndPassword)==null?void 0:q.minPasswordLength)||8,maxPasswordLength:((O=e.emailAndPassword)==null?void 0:O.maxPasswordLength)||128}},adapter:t,internalAdapter:Tt(t,n,e),createAuthCookie:je(e)}};var cd=e=>{let t=Ut(e),{api:n}=fe(t,e);return{handler:o=>d(void 0,null,function*(){let r=t.options.basePath,i=new URL(o.url);if(!t.options.baseURL){let a=`${i.origin}/api/auth`;t.options.baseURL=a,t.baseURL=a}if(!t.options.baseURL)return new Response("Base URL not set",{status:400});if(i.pathname===r||i.pathname===`${r}/`)return new Response("Welcome to BetterAuth",{status:200});let{handler:s}=ut(t,e);return s(o)}),api:n,options:t.options,$Infer:{}}};export{cd as betterAuth};
