var z=Object.defineProperty,K=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var w=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var x=(e,t,r)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,l=(e,t)=>{for(var r in t||(t={}))w.call(t,r)&&x(e,r,t[r]);if(T)for(var r of T(t))I.call(t,r)&&x(e,r,t[r]);return e},m=(e,t)=>K(e,Q(t));var B=(e,t)=>{var r={};for(var i in e)w.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(e!=null&&T)for(var i of T(e))t.indexOf(i)<0&&I.call(e,i)&&(r[i]=e[i]);return r};var y=(e,t,r)=>new Promise((i,n)=>{var d=f=>{try{s(r.next(f))}catch(u){n(u)}},c=f=>{try{s(r.throw(f))}catch(u){n(u)}},s=f=>f.done?i(f.value):Promise.resolve(f.value).then(d,c);s((r=r.apply(e,t)).next())});import{useStore as S}from"@nanostores/react";import{createFetch as J}from"@better-fetch/fetch";var p=class extends Error{constructor(t,r,i){super(t),this.name="BetterAuthError",this.message=t,this.cause=r}};function X(e){try{return new URL(e).pathname!=="/"}catch(t){throw new p(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function b(e,t="/api/auth"){return X(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function E(e,t){if(e)return b(e,t);let r=(process==null?void 0:process.env)||{},i=r.BETTER_AUTH_URL||r.NEXT_PUBLIC_BETTER_AUTH_URL||r.PUBLIC_BETTER_AUTH_URL||r.NUXT_PUBLIC_BETTER_AUTH_URL||r.NUXT_PUBLIC_AUTH_URL||(r.BASE_URL!=="/"?r.BASE_URL:void 0);if(i)return b(i,t);if(typeof window!="undefined")return b(window.location.origin,t)}import"nanostores";import{betterFetch as D}from"@better-fetch/fetch";var k={id:"redirect",name:"Redirect",hooks:{onSuccess(e){var t,r;(t=e.data)!=null&&t.url&&((r=e.data)!=null&&r.redirect)&&typeof window!="undefined"&&(window.location.href=e.data.url)}}},v={id:"add-current-url",name:"Add current URL",hooks:{onRequest(e){if(typeof window!="undefined"){let t=new URL(e.url);t.searchParams.set("currentURL",window.location.href),e.url=t}return e}}},_=new Map,$={id:"csrf",name:"CSRF Check",init(e,t){return y(this,null,function*(){if(!(t!=null&&t.baseURL))throw new p("API Base URL on the auth client isn't configured. Please pass it directly to the client `baseURL`");if((t==null?void 0:t.method)!=="GET"){t=t||{};let r=_.get("CSRF_TOKEN");if(!r){let{data:i,error:n}=yield D("/csrf",{body:void 0,baseURL:t.baseURL,plugins:[],method:"GET",credentials:"include",customFetchImpl:t.customFetchImpl});if(n){if(n.status===404)throw new p("CSRF route not found. Make sure the server is running and the base URL is correct and includes the path (e.g. http://localhost:3000/api/auth).");if(n.status===429)return new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests"});throw new p("Failed to fetch CSRF token: "+n.message)}_.set("CSRF_TOKEN",i.csrfToken)}t.body=m(l({},t==null?void 0:t.body),{csrfToken:r})}return t.credentials="include",{url:e,options:t}})}};var q=e=>{var s,f,u,a,g,P;let t=J(m(l({baseURL:E(((s=e==null?void 0:e.fetchOptions)==null?void 0:s.baseURL)||(e==null?void 0:e.baseURL)),credentials:"include"},e==null?void 0:e.fetchOptions),{plugins:[$,k,v,...((u=(f=e==null?void 0:e.fetchOptions)==null?void 0:f.plugins)==null?void 0:u.filter(o=>o!==void 0))||[],...((a=e==null?void 0:e.plugins)==null?void 0:a.flatMap(o=>o.fetchPlugins).filter(o=>o!==void 0))||[]]})),r=(e==null?void 0:e.plugins)||[],i={},n={},d={"/sign-out":"POST","/user/revoke-sessions":"POST"},c=[{signal:"_sessionSignal",matcher(o){return o==="/sign-out"||o==="sign-up/email"||o==="/user/update"}}];for(let o of r)o.getActions&&Object.assign(i,(g=o.getActions)==null?void 0:g.call(o,t)),o.getAtoms&&Object.assign(n,(P=o.getAtoms)==null?void 0:P.call(o,t)),o.pathMethods&&Object.assign(d,o.pathMethods),o.atomListeners&&c.push(...o.atomListeners);return{pluginsActions:i,pluginsAtoms:n,pluginPathMethods:d,atomListeners:c,$fetch:t}};function W(e){return e.charAt(0).toUpperCase()+e.slice(1)}function Z(e,t,r){let i=t[e],s=r||{},{fetchOptions:n,query:d}=s,c=B(s,["fetchOptions","query"]);return i||(n!=null&&n.method?n.method:c&&Object.keys(c).length>0?"POST":"GET")}function M(e,t,r,i,n){function d(c=[]){return new Proxy(function(){},{get(s,f){let u=[...c,f],a=e;for(let g of u)if(a&&typeof a=="object"&&g in a)a=a[g];else{a=void 0;break}return typeof a=="function"?a:d(u)},apply:(s,f,u)=>y(this,null,function*(){let a="/"+c.map(U=>U.replace(/[A-Z]/g,R=>`-${R.toLowerCase()}`)).join("/"),g=u[0]||{},P=u[1]||{},L=g,{query:o,fetchOptions:A}=L,G=B(L,["query","fetchOptions"]),h=l(l({},P),A),F=Z(a,r,g);return yield t(a,m(l({},h),{body:F==="GET"?void 0:l(l({},G),(h==null?void 0:h.body)||{}),query:o||(h==null?void 0:h.query),method:F,onSuccess(U){return y(this,null,function*(){var C;yield(C=h==null?void 0:h.onSuccess)==null?void 0:C.call(h,U);let R=n==null?void 0:n.find(V=>V.matcher(a));if(!R)return;let O=i[R.signal];if(!O)return;let N=O.get();setTimeout(()=>{O.set(!N)},10)})}}))})})}return d()}import{atom as te}from"nanostores";import"@better-fetch/fetch";import{atom as Y,onMount as ee}from"nanostores";var H=(e,t,r,i)=>{let n=Y({data:null,error:null,isPending:!1}),d=()=>{let s=typeof i=="function"?i({data:n.get().data,error:n.get().error,isPending:n.get().isPending}):i;return r(t,m(l({},s),{onSuccess:u=>y(void 0,null,function*(){var a;n.set({data:u.data,error:null,isPending:!1}),yield(a=s==null?void 0:s.onSuccess)==null?void 0:a.call(s,u)}),onError(u){return y(this,null,function*(){var a;n.set({error:u.error,data:null,isPending:!1}),yield(a=s==null?void 0:s.onError)==null?void 0:a.call(s,u)})},onRequest(u){return y(this,null,function*(){var g;let a=n.get();n.set({isPending:!0,data:a.data,error:a.error}),yield(g=s==null?void 0:s.onRequest)==null?void 0:g.call(s,u)})}}))};e=Array.isArray(e)?e:[e];let c=!1;for(let s of e)s.subscribe(()=>{c?d():ee(n,()=>(d(),c=!0,()=>{n.off(),s.off()}))});return n};function j(e){let t=te(!1);return{$session:H(t,"/session",e,{method:"GET"}),_sessionSignal:t,$Infer:{}}}import"react";function re(e){return`use${W(e)}`}function ve(e){let{pluginPathMethods:t,pluginsActions:r,pluginsAtoms:i,$fetch:n,atomListeners:d}=q(e),c={};for(let[o,A]of Object.entries(i))c[re(o)]=()=>S(A);let{$session:s,_sessionSignal:f,$Infer:u}=j(n);function a(o){return S(s)}let g=m(l(l({},r),c),{useSession:a});return M(g,n,t,m(l({},i),{_sessionSignal:f}),d)}var $e=S;export{ve as createAuthClient,$e as useAuthQuery};
