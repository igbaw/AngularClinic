var K=Object.defineProperty,X=Object.defineProperties;var D=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var w=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable;var C=(e,t,r)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,l=(e,t)=>{for(var r in t||(t={}))w.call(t,r)&&C(e,r,t[r]);if(R)for(var r of R(t))x.call(t,r)&&C(e,r,t[r]);return e},m=(e,t)=>X(e,D(t));var B=(e,t)=>{var r={};for(var i in e)w.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(e!=null&&R)for(var i of R(e))t.indexOf(i)<0&&x.call(e,i)&&(r[i]=e[i]);return r};var y=(e,t,r)=>new Promise((i,n)=>{var d=f=>{try{s(r.next(f))}catch(u){n(u)}},c=f=>{try{s(r.throw(f))}catch(u){n(u)}},s=f=>f.done?i(f.value):Promise.resolve(f.value).then(d,c);s((r=r.apply(e,t)).next())});import{useStore as H}from"@nanostores/solid";import{createFetch as V}from"@better-fetch/fetch";var p=class extends Error{constructor(t,r,i){super(t),this.name="BetterAuthError",this.message=t,this.cause=r}};function Q(e){try{return new URL(e).pathname!=="/"}catch(t){throw new p(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function b(e,t="/api/auth"){return Q(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function E(e,t){if(e)return b(e,t);let r=(process==null?void 0:process.env)||{},i=r.BETTER_AUTH_URL||r.NEXT_PUBLIC_BETTER_AUTH_URL||r.PUBLIC_BETTER_AUTH_URL||r.NUXT_PUBLIC_BETTER_AUTH_URL||r.NUXT_PUBLIC_AUTH_URL||(r.BASE_URL!=="/"?r.BASE_URL:void 0);if(i)return b(i,t);if(typeof window!="undefined")return b(window.location.origin,t)}import"nanostores";import{betterFetch as J}from"@better-fetch/fetch";var _={id:"redirect",name:"Redirect",hooks:{onSuccess(e){var t,r;(t=e.data)!=null&&t.url&&((r=e.data)!=null&&r.redirect)&&typeof window!="undefined"&&(window.location.href=e.data.url)}}},k={id:"add-current-url",name:"Add current URL",hooks:{onRequest(e){if(typeof window!="undefined"){let t=new URL(e.url);t.searchParams.set("currentURL",window.location.href),e.url=t}return e}}},I=new Map,v={id:"csrf",name:"CSRF Check",init(e,t){return y(this,null,function*(){if(!(t!=null&&t.baseURL))throw new p("API Base URL on the auth client isn't configured. Please pass it directly to the client `baseURL`");if((t==null?void 0:t.method)!=="GET"){t=t||{};let r=I.get("CSRF_TOKEN");if(!r){let{data:i,error:n}=yield J("/csrf",{body:void 0,baseURL:t.baseURL,plugins:[],method:"GET",credentials:"include",customFetchImpl:t.customFetchImpl});if(n){if(n.status===404)throw new p("CSRF route not found. Make sure the server is running and the base URL is correct and includes the path (e.g. http://localhost:3000/api/auth).");if(n.status===429)return new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests"});throw new p("Failed to fetch CSRF token: "+n.message)}I.set("CSRF_TOKEN",i.csrfToken)}t.body=m(l({},t==null?void 0:t.body),{csrfToken:r})}return t.credentials="include",{url:e,options:t}})}};var $=e=>{var s,f,u,o,g,P;let t=V(m(l({baseURL:E(((s=e==null?void 0:e.fetchOptions)==null?void 0:s.baseURL)||(e==null?void 0:e.baseURL)),credentials:"include"},e==null?void 0:e.fetchOptions),{plugins:[v,_,k,...((u=(f=e==null?void 0:e.fetchOptions)==null?void 0:f.plugins)==null?void 0:u.filter(a=>a!==void 0))||[],...((o=e==null?void 0:e.plugins)==null?void 0:o.flatMap(a=>a.fetchPlugins).filter(a=>a!==void 0))||[]]})),r=(e==null?void 0:e.plugins)||[],i={},n={},d={"/sign-out":"POST","/user/revoke-sessions":"POST"},c=[{signal:"_sessionSignal",matcher(a){return a==="/sign-out"||a==="sign-up/email"||a==="/user/update"}}];for(let a of r)a.getActions&&Object.assign(i,(g=a.getActions)==null?void 0:g.call(a,t)),a.getAtoms&&Object.assign(n,(P=a.getAtoms)==null?void 0:P.call(a,t)),a.pathMethods&&Object.assign(d,a.pathMethods),a.atomListeners&&c.push(...a.atomListeners);return{pluginsActions:i,pluginsAtoms:n,pluginPathMethods:d,atomListeners:c,$fetch:t}};function Z(e,t,r){let i=t[e],s=r||{},{fetchOptions:n,query:d}=s,c=B(s,["fetchOptions","query"]);return i||(n!=null&&n.method?n.method:c&&Object.keys(c).length>0?"POST":"GET")}function q(e,t,r,i,n){function d(c=[]){return new Proxy(function(){},{get(s,f){let u=[...c,f],o=e;for(let g of u)if(o&&typeof o=="object"&&g in o)o=o[g];else{o=void 0;break}return typeof o=="function"?o:d(u)},apply:(s,f,u)=>y(this,null,function*(){let o="/"+c.map(U=>U.replace(/[A-Z]/g,A=>`-${A.toLowerCase()}`)).join("/"),g=u[0]||{},P=u[1]||{},S=g,{query:a,fetchOptions:T}=S,G=B(S,["query","fetchOptions"]),h=l(l({},P),T),F=Z(o,r,g);return yield t(o,m(l({},h),{body:F==="GET"?void 0:l(l({},G),(h==null?void 0:h.body)||{}),query:a||(h==null?void 0:h.query),method:F,onSuccess(U){return y(this,null,function*(){var L;yield(L=h==null?void 0:h.onSuccess)==null?void 0:L.call(h,U);let A=n==null?void 0:n.find(z=>z.matcher(o));if(!A)return;let O=i[A.signal];if(!O)return;let N=O.get();setTimeout(()=>{O.set(!N)},10)})}}))})})}return d()}function W(e){return e.charAt(0).toUpperCase()+e.slice(1)}import{atom as te}from"nanostores";import"@better-fetch/fetch";import{atom as Y,onMount as ee}from"nanostores";var M=(e,t,r,i)=>{let n=Y({data:null,error:null,isPending:!1}),d=()=>{let s=typeof i=="function"?i({data:n.get().data,error:n.get().error,isPending:n.get().isPending}):i;return r(t,m(l({},s),{onSuccess:u=>y(void 0,null,function*(){var o;n.set({data:u.data,error:null,isPending:!1}),yield(o=s==null?void 0:s.onSuccess)==null?void 0:o.call(s,u)}),onError(u){return y(this,null,function*(){var o;n.set({error:u.error,data:null,isPending:!1}),yield(o=s==null?void 0:s.onError)==null?void 0:o.call(s,u)})},onRequest(u){return y(this,null,function*(){var g;let o=n.get();n.set({isPending:!0,data:o.data,error:o.error}),yield(g=s==null?void 0:s.onRequest)==null?void 0:g.call(s,u)})}}))};e=Array.isArray(e)?e:[e];let c=!1;for(let s of e)s.subscribe(()=>{c?d():ee(n,()=>(d(),c=!0,()=>{n.off(),s.off()}))});return n};function j(e){let t=te(!1);return{$session:M(t,"/session",e,{method:"GET"}),_sessionSignal:t,$Infer:{}}}function re(e){return`use${W(e)}`}function Ie(e){let{pluginPathMethods:t,pluginsActions:r,pluginsAtoms:i,$fetch:n,atomListeners:d}=$(e),c={};for(let[a,T]of Object.entries(i))c[re(a)]=()=>H(T);let{$session:s,_sessionSignal:f,$Infer:u}=j(n);function o(){return H(s)}let g=m(l(l({},r),c),{useSession:o});return q(g,n,t,m(l({},i),{_sessionSignal:f}),d)}export{Ie as createAuthClient};
