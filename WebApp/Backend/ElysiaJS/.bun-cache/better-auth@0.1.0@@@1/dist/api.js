var Ze=Object.defineProperty,Ke=Object.defineProperties;var Qe=Object.getOwnPropertyDescriptors;var re=Object.getOwnPropertySymbols;var Xe=Object.prototype.hasOwnProperty,Ye=Object.prototype.propertyIsEnumerable;var oe=(e,t,n)=>t in e?Ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,g=(e,t)=>{for(var n in t||(t={}))Xe.call(t,n)&&oe(e,n,t[n]);if(re)for(var n of re(t))Ye.call(t,n)&&oe(e,n,t[n]);return e},k=(e,t)=>Ke(e,Qe(t));var a=(e,t,n)=>new Promise((o,r)=>{var s=c=>{try{d(n.next(c))}catch(u){r(u)}},i=c=>{try{d(n.throw(c))}catch(u){r(u)}},d=c=>c.done?o(c.value):Promise.resolve(c.value).then(s,i);d((n=n.apply(e,t)).next())});import{APIError as Gt,createRouter as Wt}from"better-call";import{APIError as ie}from"better-call";import{z as ae}from"zod";import{xchacha20poly1305 as Xt}from"@noble/ciphers/chacha";import{bytesToHex as er,hexToBytes as tr,utf8ToBytes as rr}from"@noble/ciphers/utils";import{managedNonce as nr}from"@noble/ciphers/webcrypto";import{sha256 as ir}from"@noble/hashes/sha256";function M(e,t){return a(this,null,function*(){let n=new TextEncoder,o={name:"HMAC",hash:"SHA-256"},r=yield crypto.subtle.importKey("raw",n.encode(e),o,!1,["sign","verify"]),s=yield crypto.subtle.sign(o.name,r,n.encode(t));return btoa(String.fromCharCode(...new Uint8Array(s)))})}import{createEndpointCreator as et,createMiddleware as ne,createMiddlewareCreator as tt}from"better-call";var se=ne(()=>a(void 0,null,function*(){return{}})),H=tt({use:[se,ne(()=>a(void 0,null,function*(){return{}}))]}),f=et({use:[se]});var de=H({body:ae.object({csrfToken:ae.string().optional()}).optional()},e=>a(void 0,null,function*(){var d,c,u,l;if(((d=e.request)==null?void 0:d.method)!=="POST"||(c=e.context.options.advanced)!=null&&c.disableCSRFCheck)return;let t=new URL(e.request.url);if(t.origin===new URL(e.context.baseURL).origin||(u=e.context.options.trustedOrigins)!=null&&u.includes(t.origin))return;let n=(l=e.body)==null?void 0:l.csrfToken,o=yield e.getSignedCookie(e.context.authCookies.csrfToken.name,e.context.secret),[r,s]=(o==null?void 0:o.split("!"))||[null,null];if(!n||!o||!r||!s||o!==n)throw e.setCookie(e.context.authCookies.csrfToken.name,"",{maxAge:0}),new ie("UNAUTHORIZED",{message:"Invalid CSRF Token"});let i=yield M(e.context.secret,r);if(s!==i)throw e.setCookie(e.context.authCookies.csrfToken.name,"",{maxAge:0}),new ie("UNAUTHORIZED",{message:"Invalid CSRF Token"})}));import{APIError as E}from"better-call";import{generateCodeVerifier as vt}from"oslo/oauth2";import{z as v}from"zod";import"arctic";import{parseJWT as st}from"oslo/jwt";import"@better-fetch/fetch";var D=class extends Error{constructor(t,n,o){super(t),this.name="BetterAuthError",this.message=t,this.cause=n}};import{OAuth2Tokens as ot}from"arctic";function rt(e){try{return new URL(e).pathname!=="/"}catch(t){throw new D(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function G(e,t="/api/auth"){return rt(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function ce(e,t){if(e)return G(e,t);let n=(process==null?void 0:process.env)||{},o=n.BETTER_AUTH_URL||n.NEXT_PUBLIC_BETTER_AUTH_URL||n.PUBLIC_BETTER_AUTH_URL||n.NUXT_PUBLIC_BETTER_AUTH_URL||n.NUXT_PUBLIC_AUTH_URL||(n.BASE_URL!=="/"?n.BASE_URL:void 0);if(o)return G(o,t);if(typeof window!="undefined")return G(window.location.origin,t)}import{betterFetch as nt}from"@better-fetch/fetch";function y(e,t){return t||`${ce()}/callback/${e}`}function A(s){return a(this,arguments,function*({code:e,codeVerifier:t,redirectURI:n,options:o,tokenEndpoint:r}){let i=new URLSearchParams;i.set("grant_type","authorization_code"),i.set("code",e),t&&i.set("code_verifier",t),i.set("redirect_uri",n),i.set("client_id",o.clientId),i.set("client_secret",o.clientSecret);let{data:d,error:c}=yield nt(r,{method:"POST",body:i,headers:{"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"}});if(c)throw c;return new ot(d)})}var le=e=>{let t="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:o,scopes:r,redirectURI:s}){let i=r||["email","name","openid"];return new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${s||e.redirectURI}&scope=${i.join(" ")}&state=${o}`)},validateAuthorizationCode:(o,r,s)=>a(void 0,null,function*(){return A({code:o,codeVerifier:r,redirectURI:s||y("apple",e.redirectURI),options:e,tokenEndpoint:t})}),getUserInfo(o){return a(this,null,function*(){var s;let r=(s=st(o.idToken()))==null?void 0:s.payload;return r?{user:{id:r.sub,name:r.name,email:r.email,emailVerified:r.email_verified==="true"},data:r}:null})}}};import{betterFetch as it}from"@better-fetch/fetch";import{Discord as at}from"arctic";var ue=e=>{let t=new at(e.clientId,e.clientSecret,y("discord",e.redirectURI));return{id:"discord",name:"Discord",createAuthorizationURL({state:o,scopes:r}){let s=r||["email"];return t.createAuthorizationURL(o,s)},validateAuthorizationCode:(o,r,s)=>a(void 0,null,function*(){return A({code:o,codeVerifier:r,redirectURI:s||y("discord",e.redirectURI),options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"})}),getUserInfo(o){return a(this,null,function*(){let{data:r,error:s}=yield it("https://discord.com/api/users/@me",{auth:{type:"Bearer",token:o.accessToken()}});return s?null:{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified},data:r}})}}};import{betterFetch as dt}from"@better-fetch/fetch";import{Facebook as ct}from"arctic";var pe=e=>{let t=new ct(e.clientId,e.clientSecret,y("facebook",e.redirectURI));return{id:"facebook",name:"Facebook",createAuthorizationURL({state:o,scopes:r}){let s=r||["email","public_profile"];return t.createAuthorizationURL(o,s)},validateAuthorizationCode:(o,r,s)=>a(void 0,null,function*(){return A({code:o,codeVerifier:r,redirectURI:s||y("facebook",e.redirectURI),options:e,tokenEndpoint:"https://graph.facebook.com/v16.0/oauth/access_token"})}),getUserInfo(o){return a(this,null,function*(){let{data:r,error:s}=yield dt("https://graph.facebook.com/me",{auth:{type:"Bearer",token:o.accessToken()}});return s?null:{user:{id:r.id,name:r.name,email:r.email,emailVerified:r.email_verified},data:r}})}}};import{betterFetch as me}from"@better-fetch/fetch";import{GitHub as lt}from"arctic";var fe=({clientId:e,clientSecret:t,redirectURI:n})=>{let o=new lt(e,t,y("github",n));return{id:"github",name:"Github",createAuthorizationURL({state:s,scopes:i}){let d=i||["user:email"];return o.createAuthorizationURL(s,d)},validateAuthorizationCode:s=>a(void 0,null,function*(){return yield o.validateAuthorizationCode(s)}),getUserInfo(s){return a(this,null,function*(){var u,l,p,m;let{data:i,error:d}=yield me("https://api.github.com/user",{auth:{type:"Bearer",token:s.accessToken()}});if(d)return null;let c=!1;if(!i.email){let{data:w,error:U}=yield me("https://api.github.com/user/emails",{auth:{type:"Bearer",token:s.accessToken()}});U||(i.email=(l=(u=w.find(T=>T.primary))!=null?u:w[0])==null?void 0:l.email,c=(m=(p=w.find(T=>T.email===i.email))==null?void 0:p.verified)!=null?m:!1)}return{user:{id:i.id,name:i.name,email:i.email,image:i.avatar_url,emailVerified:c,createdAt:new Date,updatedAt:new Date},data:i}})}}};import{Google as mt}from"arctic";import{parseJWT as ft}from"oslo/jwt";import{createConsola as ut}from"consola";var $=ut({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),pt=e=>({log:(...t)=>{!(e!=null&&e.disabled)&&$.log("",...t)},error:(...t)=>{!(e!=null&&e.disabled)&&$.error("",...t)},warn:(...t)=>{!(e!=null&&e.disabled)&&$.warn("",...t)},info:(...t)=>{!(e!=null&&e.disabled)&&$.info("",...t)},debug:(...t)=>{!(e!=null&&e.disabled)&&$.debug("",...t)},box:(...t)=>{!(e!=null&&e.disabled)&&$.box("",...t)},success:(...t)=>{!(e!=null&&e.disabled)&&$.success("",...t)},break:(...t)=>{!(e!=null&&e.disabled)&&console.log(`
`)}}),_=pt();var ge=e=>{let t=new mt(e.clientId,e.clientSecret,y("google",e.redirectURI));return{id:"google",name:"Google",createAuthorizationURL({state:o,scopes:r,codeVerifier:s,redirectURI:i}){if(!e.clientId||!e.clientSecret)throw _.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new D("CLIENT_ID_AND_SECRET_REQUIRED");if(!s)throw new D("codeVerifier is required for Google");let d=r||["email","profile"];return t.createAuthorizationURL(o,s,d)},validateAuthorizationCode:(o,r,s)=>a(void 0,null,function*(){return A({code:o,codeVerifier:r,redirectURI:s||y("google",e.redirectURI),options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"})}),getUserInfo(o){return a(this,null,function*(){var s;if(!o.idToken)return null;let r=(s=ft(o.idToken()))==null?void 0:s.payload;return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified},data:r}})}}};import{betterFetch as gt}from"@better-fetch/fetch";import{Spotify as ht}from"arctic";var he=e=>{let t=new ht(e.clientId,e.clientSecret,y("spotify",e.redirectURI));return{id:"spotify",name:"Spotify",createAuthorizationURL({state:o,scopes:r}){let s=r||["user-read-email"];return t.createAuthorizationURL(o,s)},validateAuthorizationCode:(o,r,s)=>a(void 0,null,function*(){return A({code:o,codeVerifier:r,redirectURI:s||y("spotify",e.redirectURI),options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"})}),getUserInfo(o){return a(this,null,function*(){var i;let{data:r,error:s}=yield gt("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken()}`}});return s?null:{user:{id:r.id,name:r.display_name,email:r.email,image:(i=r.images[0])==null?void 0:i.url,emailVerified:!1},data:r}})}}};import{betterFetch as yt}from"@better-fetch/fetch";import{Twitch as wt}from"arctic";var ye=e=>{let t=new wt(e.clientId,e.clientSecret,y("twitch",e.redirectURI));return{id:"twitch",name:"Twitch",createAuthorizationURL({state:o,scopes:r}){let s=r||["activity:write","read"];return t.createAuthorizationURL(o,s)},validateAuthorizationCode:(o,r,s)=>a(void 0,null,function*(){return A({code:o,codeVerifier:r,redirectURI:s||y("twitch",e.redirectURI),options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"})}),getUserInfo(o){return a(this,null,function*(){let{data:r,error:s}=yield yt("https://api.twitch.tv/helix/users",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken()}`}});return s?null:{user:{id:r.sub,name:r.preferred_username,email:r.email,image:r.picture,emailVerified:!1},data:r}})}}};import{betterFetch as bt}from"@better-fetch/fetch";import{Twitter as kt}from"arctic";var we=e=>{let t=new kt(e.clientId,e.clientSecret,y("twitter",e.redirectURI));return{id:"twitter",name:"Twitter",createAuthorizationURL(o){let r=o.scopes||["account_info.read"];return t.createAuthorizationURL(o.state,o.codeVerifier,r)},validateAuthorizationCode:(o,r,s)=>a(void 0,null,function*(){return A({code:o,codeVerifier:r,redirectURI:s||y("twitch",e.redirectURI),options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"})}),getUserInfo(o){return a(this,null,function*(){let{data:r,error:s}=yield bt("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken()}`}});return s||!r.data.email?null:{user:{id:r.data.id,name:r.data.name,email:r.data.email,image:r.data.profile_image_url,emailVerified:r.data.verified||!1},data:r}})}}};import"arctic";var At={apple:le,discord:ue,facebook:pe,github:fe,google:ge,spotify:he,twitch:ye,twitter:we},be=Object.keys(At);import{generateState as Rt}from"oslo/oauth2";import{z as q}from"zod";function ke(e,t,n){let o=Rt();return{state:JSON.stringify({code:o,callbackURL:e,currentURL:t,dontRememberMe:n}),code:o}}function W(e){return q.object({code:q.string(),callbackURL:q.string().optional(),currentURL:q.string().optional(),dontRememberMe:q.boolean().optional()}).safeParse(JSON.parse(e))}import{APIError as Ut}from"better-call";var Ae=(e,t=!1)=>{let n=new Date;return new Date(n.getTime()+(t?e*1e3:e))};import{TimeSpan as Zo}from"oslo";function P(e,t,n,o){return a(this,null,function*(){let r=e.context.authCookies.sessionToken.options;r.maxAge=n?void 0:r.maxAge,yield e.setSignedCookie(e.context.authCookies.sessionToken.name,t,e.context.secret,r),n&&(yield e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options))})}function V(e){e.setCookie(e.context.authCookies.sessionToken.name,"",{maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{maxAge:0})}import{z as Re}from"zod";function N(e){let t="127.0.0.1";if(process.env.NODE_ENV==="test")return t;let n=["x-client-ip","x-forwarded-for","cf-connecting-ip","fastly-client-ip","x-real-ip","x-cluster-client-ip","x-forwarded","forwarded-for","forwarded"];for(let o of n){let r=e.headers.get(o);if(typeof r=="string"){let s=r.split(",")[0].trim();if(s)return s}}return null}var J=new Map;function Tt(e,t){if(!e.request)return"";let{method:n,url:o,headers:r}=e.request,s=e.request.headers.get("User-Agent")||"",i=N(e.request)||"",d=JSON.stringify(r);return`${n}:${o}:${d}:${s}:${i}:${t}`}var Z=()=>f("/session",{method:"GET",requireHeaders:!0},e=>a(void 0,null,function*(){try{let t=yield e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)return e.json(null,{status:401});let n=Tt(e,t),o=J.get(n);if(o){if(o.expiresAt>Date.now())return e.json(o.data);J.delete(n)}let r=yield e.context.internalAdapter.findSession(t);if(!r||r.session.expiresAt<new Date)return V(e),r&&(yield e.context.internalAdapter.deleteSession(r.session.id)),e.json(null,{status:401});if(yield e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret))return e.json(r);let i=e.context.sessionConfig.expiresIn,d=e.context.sessionConfig.updateAge;if(r.session.expiresAt.valueOf()-i*1e3+d*1e3<=Date.now()){let l=yield e.context.internalAdapter.updateSession(r.session.id,{expiresAt:Ae(e.context.sessionConfig.expiresIn,!0)});if(!l)return V(e),e.json(null,{status:401});let p=(l.expiresAt.valueOf()-Date.now())/1e3;return yield P(e,l.id,!1,{maxAge:p}),e.json({session:l,user:r.user})}return J.set(n,{data:r,expiresAt:Date.now()+5e3}),e.json(r)}catch(t){return e.context.logger.error(t),e.json(null,{status:500})}})),K=e=>a(void 0,null,function*(){return yield Z()(k(g({},e),{_flag:void 0}))}),B=H(e=>a(void 0,null,function*(){let t=yield K(e);if(!(t!=null&&t.session))throw new Ut("UNAUTHORIZED");return{session:t}})),Ue=()=>f("/user/list-sessions",{method:"GET",use:[B],requireHeaders:!0},e=>a(void 0,null,function*(){let n=(yield e.context.adapter.findMany({model:e.context.tables.session.tableName,where:[{field:"userId",value:e.context.session.user.id}]})).filter(o=>o.expiresAt>new Date);return e.json(n)})),Te=f("/user/revoke-session",{method:"POST",body:Re.object({id:Re.string()}),use:[B],requireHeaders:!0},e=>a(void 0,null,function*(){let t=e.body.id,n=yield e.context.internalAdapter.findSession(t);if(!n)return e.json(null,{status:400});if(n.session.userId!==e.context.session.user.id)return e.json(null,{status:403});try{yield e.context.internalAdapter.deleteSession(t)}catch(o){return e.context.logger.error(o),e.json(null,{status:500})}return e.json({status:!0})})),ve=f("/user/revoke-sessions",{method:"POST",use:[B],requireHeaders:!0},e=>a(void 0,null,function*(){try{yield e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(t){return e.context.logger.error(t),e.json(null,{status:500})}return e.json({status:!0})}));var xe=f("/sign-in/social",{method:"POST",requireHeaders:!0,query:v.object({currentURL:v.string().optional()}).optional(),body:v.object({callbackURL:v.string().optional(),provider:v.enum(be),dontRememberMe:v.boolean().default(!1).optional()})},e=>a(void 0,null,function*(){var i,d,c,u;let t=e.context.socialProviders.find(l=>l.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider to your auth config",{provider:e.body.provider}),new E("NOT_FOUND",{message:"Provider not found"});let n=e.context.authCookies,o=(i=e.query)!=null&&i.currentURL?new URL((d=e.query)==null?void 0:d.currentURL):null,r=(c=e.body.callbackURL)!=null&&c.startsWith("http")?e.body.callbackURL:`${o==null?void 0:o.origin}${e.body.callbackURL||""}`,s=ke(r||(o==null?void 0:o.origin)||e.context.baseURL,(u=e.query)==null?void 0:u.currentURL);try{yield e.setSignedCookie(n.state.name,s.code,e.context.secret,n.state.options);let l=vt();yield e.setSignedCookie(n.pkCodeVerifier.name,l,e.context.secret,n.pkCodeVerifier.options);let p=t.createAuthorizationURL({state:s.state,codeVerifier:l});return p.searchParams.set("redirect_uri",`${e.context.baseURL}/callback/${e.body.provider}`),{url:p.toString(),state:s.state,codeVerifier:l,redirect:!0}}catch(l){throw new E("INTERNAL_SERVER_ERROR")}})),Pe=f("/sign-in/email",{method:"POST",body:v.object({email:v.string().email(),password:v.string(),callbackURL:v.string().optional(),dontRememberMe:v.boolean().default(!1).optional()})},e=>a(void 0,null,function*(){var l,p;if(!((p=(l=e.context.options)==null?void 0:l.emailAndPassword)!=null&&p.enabled))throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new E("BAD_REQUEST",{message:"Email and password is not enabled"});let t=yield K(e);t&&(yield e.context.internalAdapter.deleteSession(t.session.id));let{email:n,password:o}=e.body;if(!v.string().email().safeParse(n).success)throw new E("BAD_REQUEST",{message:"Invalid email"});let s=yield e.context.internalAdapter.findUserByEmail(n);if(!s)throw yield e.context.password.hash(o),e.context.logger.error("User not found",{email:n}),new E("UNAUTHORIZED",{message:"Invalid email or password"});let i=s.accounts.find(m=>m.providerId==="credential");if(!i)throw e.context.logger.error("Credential account not found",{email:n}),new E("UNAUTHORIZED",{message:"Invalid email or password"});let d=i==null?void 0:i.password;if(!d)throw e.context.logger.error("Password not found",{email:n}),new E("UNAUTHORIZED",{message:"Unexpected error"});if(!(yield e.context.password.verify(d,o)))throw e.context.logger.error("Invalid password"),new E("UNAUTHORIZED",{message:"Invalid email or password"});let u=yield e.context.internalAdapter.createSession(s.user.id,e.headers,e.body.dontRememberMe);return yield P(e,u.id,e.body.dontRememberMe),e.json({user:s.user,session:u,redirect:!!e.body.callbackURL,url:e.body.callbackURL})}));import{APIError as St}from"better-call";import{z as F}from"zod";import{z as h}from"zod";var bn=h.object({id:h.string(),providerId:h.string(),accountId:h.string(),userId:h.string(),accessToken:h.string().nullable().optional(),refreshToken:h.string().nullable().optional(),idToken:h.string().nullable().optional(),expiresAt:h.date().nullable().optional(),password:h.string().optional().nullable()}),Se=h.object({id:h.string(),email:h.string().transform(e=>e.toLowerCase()),emailVerified:h.boolean().default(!1),name:h.string(),image:h.string().optional(),createdAt:h.date().default(new Date),updatedAt:h.date().default(new Date)}),kn=h.object({id:h.string(),userId:h.string(),expiresAt:h.date(),ipAddress:h.string().optional(),userAgent:h.string().optional()});import{alphabet as xt,generateRandomString as Pt}from"oslo/crypto";var _e=()=>Pt(36,xt("a-z","0-9"));var C={isAction:!1};function Q(e){let t=e.accessToken(),n=e.hasRefreshToken()?e.refreshToken():void 0,o;try{o=e.accessTokenExpiresAt()}catch(r){}return{accessToken:t,refreshToken:n,expiresAt:o}}var Ie=f("/callback/:id",{method:"GET",query:F.object({state:F.string(),code:F.string().optional(),error:F.string().optional()}),metadata:C},e=>a(void 0,null,function*(){var U,T,O;if(e.query.error||!e.query.code){let R=((U=W(e.query.state).data)==null?void 0:U.callbackURL)||`${e.context.baseURL}/error`;throw e.context.logger.error(e.query.error,e.params.id),e.redirect(`${R}?error=${e.query.error||"oAuth_code_missing"}`)}let t=e.context.socialProviders.find(b=>b.id===e.params.id);if(!t)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),e.redirect(`${e.context.baseURL}/error?error=oauth_provider_not_found`);let n=yield e.getSignedCookie(e.context.authCookies.pkCodeVerifier.name,e.context.secret),o;try{o=yield t.validateAuthorizationCode(e.query.code,n,`${e.context.baseURL}/callback/${t.id}`)}catch(b){throw e.context.logger.error(b),e.redirect(`${e.context.baseURL}/error?error=oauth_code_verification_failed`)}let r=yield t.getUserInfo(o).then(b=>b==null?void 0:b.user),s=_e(),i=Se.safeParse(k(g({},r),{id:s})),d=W(e.query.state);if(!d.success)throw e.context.logger.error("Unable to parse state"),e.redirect(`${e.context.baseURL}/error?error=invalid_state_parameter`);let{callbackURL:c,currentURL:u,dontRememberMe:l}=d.data;if(!r||i.success===!1)throw e.redirect(`${e.context.baseURL}/error?error=oauth_validation_failed`);if(!c)throw e.redirect(`${e.context.baseURL}/error?error=oauth_callback_url_not_found`);let p=yield e.context.internalAdapter.findUserByEmail(r.email),m=p==null?void 0:p.user.id;if(p){let b=p.accounts.find(j=>j.providerId===t.id),R=(O=(T=e.context.options.account)==null?void 0:T.accountLinking)==null?void 0:O.trustedProviders,z=R?R.includes(t.id):!0,te=!b&&r.emailVerified&&z;if(!te){let j;try{j=new URL(u||c),j.searchParams.set("error","account_not_linked")}catch(Zt){throw e.redirect(`${e.context.baseURL}/error?error=account_not_linked`)}throw e.redirect(j.toString())}if(te)try{yield e.context.internalAdapter.linkAccount(g({providerId:t.id,accountId:r.id,id:`${t.id}:${r.id}`,userId:p.user.id},Q(o)))}catch(j){throw console.log(j),e.redirect(`${e.context.baseURL}/error?error=failed_linking_account`)}}else try{yield e.context.internalAdapter.createOAuthUser(i.data,k(g({},Q(o)),{id:`${t.id}:${r.id}`,providerId:t.id,accountId:r.id,userId:s}))}catch(b){let R=new URL(u||c);throw R.searchParams.set("error","unable_to_create_user"),e.setHeader("Location",R.toString()),e.redirect(R.toString())}if(!m&&!s)throw new St("INTERNAL_SERVER_ERROR",{message:"Unable to create user"});let w=yield e.context.internalAdapter.createSession(m||s,e.request,l);try{yield P(e,w.id,l)}catch(b){e.context.logger.error("Unable to set session cookie",b);let R=new URL(u||c);throw R.searchParams.set("error","unable_to_create_session"),e.redirect(R.toString())}throw e.redirect(c)}));import{z as X}from"zod";var Le=f("/sign-out",{method:"POST",body:X.optional(X.object({callbackURL:X.string().optional()}))},e=>a(void 0,null,function*(){var n,o;let t=yield e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);return t?(yield e.context.internalAdapter.deleteSession(t),V(e),e.json(null,{body:{redirect:!!((n=e.body)!=null&&n.callbackURL),url:(o=e.body)==null?void 0:o.callbackURL}})):e.json(null)}));import{TimeSpan as _t}from"oslo";import{createJWT as It,parseJWT as Lt}from"oslo/jwt";import{validateJWT as Oe}from"oslo/jwt";import{z as x}from"zod";var Ee=f("/forget-password",{method:"POST",body:x.object({email:x.string().email(),redirectTo:x.string()})},e=>a(void 0,null,function*(){var s;if(!((s=e.context.options.emailAndPassword)!=null&&s.sendResetPassword))return e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPasswordToken function to your auth config!"),e.json(null,{status:400,statusText:"RESET_PASSWORD_EMAIL_NOT_SENT",body:{message:"Reset password isn't enabled"}});let{email:t}=e.body,n=yield e.context.internalAdapter.findUserByEmail(t);if(!n)return e.json({status:!1},{body:{status:!0}});let o=yield It("HS256",Buffer.from(e.context.secret),{email:n.user.email,redirectTo:e.body.redirectTo},{expiresIn:new _t(1,"h"),issuer:"better-auth",subject:"forget-password",audiences:[n.user.email],includeIssuedTimestamp:!0}),r=`${e.context.baseURL}/reset-password/${o}`;return yield e.context.options.emailAndPassword.sendResetPassword(r,n.user),e.json({status:!0})})),Ce=f("/reset-password/:token",{method:"GET"},e=>a(void 0,null,function*(){var s;let{token:t}=e.params,n,o=x.object({email:x.string(),redirectTo:x.string()});try{if(n=yield Oe("HS256",Buffer.from(e.context.secret),t),!n.expiresAt||n.expiresAt<new Date)throw Error("Token expired")}catch(i){let d=Lt(t),c=o.safeParse(d==null?void 0:d.payload);throw c.success?e.redirect(`${(s=c.data)==null?void 0:s.redirectTo}?error=invalid_token`):e.redirect(`${e.context.baseURL}/error?error=invalid_token`)}let{redirectTo:r}=o.parse(n.payload);throw e.redirect(`${r}?token=${t}`)})),je=f("/reset-password",{method:"POST",query:x.object({currentURL:x.string()}).optional(),body:x.object({newPassword:x.string(),callbackURL:x.string().optional()})},e=>a(void 0,null,function*(){var o,r,s;let t=(o=e.query)==null?void 0:o.currentURL.split("?token=")[1];if(!t)return e.json({error:"Invalid token",data:null},{status:400,statusText:"INVALID_TOKEN",body:{message:"Invalid token"}});let{newPassword:n}=e.body;try{let i=yield Oe("HS256",Buffer.from(e.context.secret),t),d=x.string().email().parse(i.payload.email),c=yield e.context.internalAdapter.findUserByEmail(d);if(!c)return e.json({error:"User not found",data:null},{status:400,body:{message:"failed to reset password"}});if(n.length<(((r=e.context.options.emailAndPassword)==null?void 0:r.minPasswordLength)||8)||n.length>(((s=e.context.options.emailAndPassword)==null?void 0:s.maxPasswordLength)||32))return e.json({data:null,error:"password is too short or too long"},{status:400,statusText:"INVALID_PASSWORD_LENGTH",body:{message:"password is too short or too long"}});let u=yield e.context.password.hash(n);return(yield e.context.internalAdapter.updatePassword(c.user.id,u))?e.json({error:null,data:{status:!0,url:e.body.callbackURL,redirect:!!e.body.callbackURL}},{body:{status:!0,url:e.body.callbackURL,redirect:!!e.body.callbackURL}}):e.json(null,{status:400,statusText:"USER_NOT_FOUND",body:{message:"User doesn't have a credential account"}})}catch(i){return console.log(i),e.json({error:"Invalid token",data:null},{status:400,statusText:"INVALID_TOKEN",body:{message:"Invalid token"}})}}));import{TimeSpan as Ot}from"oslo";import{createJWT as Et,validateJWT as Ct}from"oslo/jwt";import{z as S}from"zod";function Y(e,t){return a(this,null,function*(){return yield Et("HS256",Buffer.from(e),{email:t.toLowerCase()},{expiresIn:new Ot(1,"h"),issuer:"better-auth",subject:"verify-email",audiences:[t],includeIssuedTimestamp:!0})})}var De=f("/send-verification-email",{method:"POST",query:S.object({currentURL:S.string().optional()}).optional(),body:S.object({email:S.string().email(),callbackURL:S.string().optional()})},e=>a(void 0,null,function*(){var r,s;if(!((r=e.context.options.emailAndPassword)!=null&&r.sendVerificationEmail))return e.context.logger.error("Verification email isn't enabled. Pass `sendVerificationEmail` in `emailAndPassword` options to enable it."),e.json(null,{status:400,statusText:"VERIFICATION_EMAIL_NOT_SENT",body:{message:"Verification email isn't enabled"}});let{email:t}=e.body,n=yield Y(e.context.secret,t),o=`${e.context.baseURL}/verify-email?token=${n}&callbackURL=${e.body.callbackURL||((s=e.query)==null?void 0:s.currentURL)||"/"}`;return yield e.context.options.emailAndPassword.sendVerificationEmail(t,o,n),e.json({status:!0})})),$e=f("/verify-email",{method:"GET",query:S.object({token:S.string(),callbackURL:S.string().optional()})},e=>a(void 0,null,function*(){let{token:t}=e.query,n;try{n=yield Ct("HS256",Buffer.from(e.context.secret),t)}catch(d){return e.context.logger.error("Failed to verify email",d),e.json(null,{status:400,statusText:"INVALID_TOKEN",body:{message:"Invalid token"}})}let r=S.object({email:S.string().email()}).parse(n.payload),s=yield e.context.internalAdapter.findUserByEmail(r.email);if(!s)return e.json(null,{status:400,statusText:"USER_NOT_FOUND",body:{message:"User not found"}});if(!s.accounts.find(d=>d.providerId==="credential"))throw e.redirect;if(yield e.context.internalAdapter.updateUserByEmail(r.email,{emailVerified:!0}),e.query.callbackURL)throw console.log("Redirecting to",e.query.callbackURL),e.redirect("/");return e.json({status:!0})}));import{z as I}from"zod";import{alphabet as jt,generateRandomString as Dt}from"oslo/crypto";import"better-call";var Be=f("/user/update",{method:"POST",body:I.object({name:I.string().optional(),image:I.string().optional()}),use:[B]},e=>a(void 0,null,function*(){let{name:t,image:n}=e.body,o=e.context.session;if(!n&&!t)return e.json(o.user);let r=yield e.context.internalAdapter.updateUserByEmail(o.user.email,{name:t,image:n});return e.json(r)})),ze=f("/user/change-password",{method:"POST",body:I.object({newPassword:I.string(),currentPassword:I.string(),revokeOtherSessions:I.boolean().optional()}),use:[B]},e=>a(void 0,null,function*(){let{newPassword:t,currentPassword:n,revokeOtherSessions:o}=e.body,r=e.context.session,s=e.context.password.config.minPasswordLength;if(t.length<s)return e.context.logger.error("Password is too short"),e.json(null,{status:400,body:{message:"Password is too short"}});let i=e.context.password.config.maxPasswordLength;if(t.length>i)return e.context.logger.error("Password is too long"),e.json(null,{status:400,body:{message:"Password is too long"}});let c=(yield e.context.internalAdapter.findAccounts(r.user.id)).find(p=>p.providerId==="credential"&&p.password);if(!c||!c.password)return e.json(null,{status:400,body:{message:"User does not have a password"}});let u=yield e.context.password.hash(t);if(!(yield e.context.password.verify(c.password,n)))return e.json(null,{status:400,body:{message:"Invalid password"}});if(yield e.context.internalAdapter.updateAccount(c.id,{password:u}),o){yield e.context.internalAdapter.deleteSessions(r.user.id);let p=yield e.context.internalAdapter.createSession(r.user.id,e.headers);yield P(e,p.id)}return e.json(r.user)})),qe=f("/user/set-password",{method:"POST",body:I.object({newPassword:I.string()}),use:[B]},e=>a(void 0,null,function*(){let{newPassword:t}=e.body,n=e.context.session,o=e.context.password.config.minPasswordLength;if(t.length<o)return e.context.logger.error("Password is too short"),e.json(null,{status:400,body:{message:"Password is too short"}});let r=e.context.password.config.maxPasswordLength;if(t.length>r)return e.context.logger.error("Password is too long"),e.json(null,{status:400,body:{message:"Password is too long"}});let i=(yield e.context.internalAdapter.findAccounts(n.user.id)).find(c=>c.providerId==="credential"&&c.password),d=yield e.context.password.hash(t);return i?e.json(null,{status:400,body:{message:"User already has a password"}}):(yield e.context.internalAdapter.linkAccount({id:Dt(32,jt("a-z","0-9","A-Z")),userId:n.user.id,providerId:"credential",accountId:n.user.id,password:d}),e.json(n.user))}));import{alphabet as $t,generateRandomString as Bt}from"oslo/crypto";var Ve=f("/csrf",{method:"GET",metadata:C},e=>a(void 0,null,function*(){let t=yield e.getSignedCookie(e.context.authCookies.csrfToken.name,e.context.secret);if(t)return{csrfToken:t};let n=Bt(32,$t("a-z","0-9","A-Z")),o=yield M(e.context.secret,n),r=`${n}!${o}`;return yield e.setSignedCookie(e.context.authCookies.csrfToken.name,r,e.context.secret,e.context.authCookies.csrfToken.options),{csrfToken:n}}));var zt=(e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon">\u26A0\uFE0F</div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${e}</span></div>
    </div>
</body>
</html>`,Me=f("/error",{method:"GET",metadata:C},e=>a(void 0,null,function*(){var n;let t=new URL(((n=e.request)==null?void 0:n.url)||"").searchParams.get("error")||"Unknown";return new Response(zt(t),{headers:{"Content-Type":"text/html"}})}));var He=f("/ok",{method:"GET",metadata:C},e=>a(void 0,null,function*(){return e.json({ok:!0})}));import{alphabet as Ne,generateRandomString as Fe}from"oslo/crypto";import{z as L}from"zod";var Ge=f("/sign-up/email",{method:"POST",query:L.object({currentURL:L.string().optional()}).optional(),body:L.object({name:L.string(),email:L.string(),password:L.string(),image:L.string().optional(),callbackURL:L.string().optional()})},e=>a(void 0,null,function*(){var m,w,U,T;if(!((m=e.context.options.emailAndPassword)!=null&&m.enabled))return e.json(null,{status:400,body:{message:"Email and password is not enabled"}});let{name:t,email:n,password:o,image:r}=e.body;if(!L.string().email().safeParse(n).success)return e.json(null,{status:400,body:{message:"Invalid email address"}});let i=e.context.password.config.minPasswordLength;if(o.length<i)return e.context.logger.error("Password is too short"),e.json(null,{status:400,body:{message:"Password is too short"}});let d=e.context.password.config.maxPasswordLength;if(o.length>d)return e.context.logger.error("Password is too long"),e.json(null,{status:400,body:{message:"Password is too long"}});let c=yield e.context.internalAdapter.findUserByEmail(n),u=yield e.context.password.hash(o);if(c!=null&&c.user)return e.json(null,{status:400,body:{message:"User already exists"}});let l=yield e.context.internalAdapter.createUser({id:Fe(32,Ne("a-z","0-9","A-Z")),email:n.toLowerCase(),name:t,image:r,emailVerified:!1,createdAt:new Date,updatedAt:new Date});yield e.context.internalAdapter.linkAccount({id:Fe(32,Ne("a-z","0-9","A-Z")),userId:l.id,providerId:"credential",accountId:l.id,password:u});let p=yield e.context.internalAdapter.createSession(l.id,e.request);if(yield P(e,p.id),e.context.options.emailAndPassword.sendEmailVerificationOnSignUp){let O=yield Y(e.context.secret,l.email),b=`${e.context.baseURL}/verify-email?token=${O}&callbackURL=${e.body.callbackURL||((w=e.query)==null?void 0:w.currentURL)||"/"}`;yield(T=(U=e.context.options.emailAndPassword).sendVerificationEmail)==null?void 0:T.call(U,l.email,b,O)}return e.json({user:l,session:p},{body:e.body.callbackURL?{url:e.body.callbackURL,redirect:!0}:{user:l,session:p}})}));import ee from"chalk";function qt(e,t,n){let o=Date.now(),r=t*1e3;return o-n.lastRequest<r&&n.count>=e}function Vt(e){return new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests",headers:{"X-Retry-After":e.toString()}})}function Mt(e,t){let n=Date.now(),o=t*1e3;return Math.ceil((e+o-n)/1e3)}function Ht(e,t){let n=t!=null?t:"rateLimit",o=e.adapter;return{get:r=>a(this,null,function*(){return yield o.findOne({model:n,where:[{field:"key",value:r}]})}),set:(r,s,i)=>a(this,null,function*(){try{i?yield o.update({model:t!=null?t:"rateLimit",where:[{field:"key",value:r}],update:{count:s.count,lastRequest:s.lastRequest}}):yield o.create({model:t!=null?t:"rateLimit",data:{key:r,count:s.count,lastRequest:s.lastRequest}})}catch(d){_.error("Error setting rate limit",d)}})}}var We=new Map;function Nt(e){if(e.rateLimit.customStorage)return e.rateLimit.customStorage;if(e.rateLimit.storage==="memory"){let n;return{get(o){return a(this,null,function*(){return We.get(o)})},set(o,r,s){return a(this,null,function*(){We.set(o,r)})}}}return Ht(e,e.rateLimit.tableName)}function Je(e,t){return a(this,null,function*(){if(!t.rateLimit.enabled)return;let n=t.baseURL,o=e.url.replace(n,""),r=t.rateLimit.window,s=t.rateLimit.max,i=N(e)+o,c=Ft().find(m=>m.pathMatcher(o));c&&(r=c.window,s=c.max);for(let m of t.options.plugins||[])if(m.rateLimit){let w=m.rateLimit.find(U=>U.pathMatcher(o));if(w){r=w.window,s=w.max;break}}if(t.rateLimit.customRules){let m=t.rateLimit.customRules[o];m&&(r=m.window,s=m.max)}let u=Nt(t),l=yield u.get(i),p=Date.now();if(!l)yield u.set(i,{key:i,count:1,lastRequest:p});else{let m=p-l.lastRequest;if(qt(s,r,l)){let w=Mt(l.lastRequest,r);return Vt(w)}else m>r*1e3?yield u.set(i,k(g({},l),{count:1,lastRequest:p})):yield u.set(i,k(g({},l),{count:l.count+1,lastRequest:p}))}})}function Ft(){return[{pathMatcher(t){return t.startsWith("/sign-in")||t.startsWith("/sign-up")},window:10,max:7}]}function Jt(e,t){var d,c;let n=(d=e.options.plugins)==null?void 0:d.reduce((u,l)=>g(g({},u),l.endpoints),{}),o=((c=e.options.plugins)==null?void 0:c.map(u=>{var l;return(l=u.middlewares)==null?void 0:l.map(p=>{let m=w=>a(this,null,function*(){return p.middleware(k(g({},w),{context:g(g({},e),w.context)}))});return m.path=p.path,m.options=p.middleware.options,m.headers=p.middleware.headers,{path:p.path,middleware:m}})}).filter(u=>u!==void 0).flat())||[],r={signInOAuth:xe,callbackOAuth:Ie,getCSRFToken:Ve,getSession:Z(),signOut:Le,signUpEmail:Ge,signInEmail:Pe,forgetPassword:Ee,resetPassword:je,verifyEmail:$e,sendVerificationEmail:De,changePassword:ze,setPassword:qe,updateUser:Be,forgetPasswordCallback:Ce,listSessions:Ue(),revokeSession:Te,revokeSessions:ve},s=k(g(g({},r),n),{ok:He,error:Me}),i={};for(let[u,l]of Object.entries(s))i[u]=p=>a(this,null,function*(){var U;let w=yield l(k(g({},p),{context:g(g({},e),p.context)}));for(let T of e.options.plugins||[])if((U=T.hooks)!=null&&U.after){for(let O of T.hooks.after)if(O.matcher(p)){let R=Object.assign(p,{context:k(g({},e),{returned:w})}),z=yield O.handler(R);z&&"response"in z&&(w=z.response)}}return w}),i[u].path=l.path,i[u].method=l.method,i[u].options=l.options,i[u].headers=l.headers;return{api:i,middlewares:o}}var Li=(e,t)=>{let{api:n,middlewares:o}=Jt(e,t),r=new URL(e.baseURL).pathname;return Wt(n,{extraContext:e,basePath:r,routerMiddleware:[{path:"/**",middleware:de},...o],onRequest(i){return a(this,null,function*(){return Je(i,e)})},onError(i){var c,u,l,p;let d=(c=t.logger)!=null&&c.verboseLogging?_:void 0;if(((u=t.logger)==null?void 0:u.disabled)!==!0)if(i instanceof Gt)d==null||d.warn(i);else if(typeof i=="object"&&i!==null&&"message"in i){let m=i.message;if(!m||typeof m!="string"){d==null||d.error(i);return}m.includes("no such table")?(l=_)==null||l.error(`Please run ${ee.green("npx better-auth migrate")} to create the tables. There are missing tables in your SQLite database.`):m.includes("relation")&&m.includes("does not exist")?_.error(`Please run ${ee.green("npx better-auth migrate")} to create the tables. There are missing tables in your PostgreSQL database.`):m.includes("Table")&&m.includes("doesn't exist")?(p=_)==null||p.error(`Please run ${ee.green("npx better-auth migrate")} to create the tables. There are missing tables in your MySQL database.`):d==null||d.error(i)}else d==null||d.error(i)}})};export{Ie as callbackOAuth,ze as changePassword,f as createAuthEndpoint,H as createAuthMiddleware,Y as createEmailVerificationToken,de as csrfMiddleware,Me as error,Ee as forgetPassword,Ce as forgetPasswordCallback,Ve as getCSRFToken,Jt as getEndpoints,Z as getSession,K as getSessionFromCtx,Ue as listSessions,He as ok,se as optionsMiddleware,je as resetPassword,Te as revokeSession,ve as revokeSessions,Li as router,De as sendVerificationEmail,B as sessionMiddleware,qe as setPassword,Pe as signInEmail,xe as signInOAuth,Le as signOut,Ge as signUpEmail,Be as updateUser,$e as verifyEmail};
