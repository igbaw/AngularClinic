var z=Object.defineProperty,X=Object.defineProperties;var D=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var S=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var C=(e,t,r)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,l=(e,t)=>{for(var r in t||(t={}))S.call(t,r)&&C(e,r,t[r]);if(R)for(var r of R(t))w.call(t,r)&&C(e,r,t[r]);return e},m=(e,t)=>X(e,D(t));var O=(e,t)=>{var r={};for(var i in e)S.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(e!=null&&R)for(var i of R(e))t.indexOf(i)<0&&w.call(e,i)&&(r[i]=e[i]);return r};var y=(e,t,r)=>new Promise((i,n)=>{var d=f=>{try{s(r.next(f))}catch(u){n(u)}},c=f=>{try{s(r.throw(f))}catch(u){n(u)}},s=f=>f.done?i(f.value):Promise.resolve(f.value).then(d,c);s((r=r.apply(e,t)).next())});import{createFetch as J}from"@better-fetch/fetch";var p=class extends Error{constructor(t,r,i){super(t),this.name="BetterAuthError",this.message=t,this.cause=r}};function K(e){try{return new URL(e).pathname!=="/"}catch(t){throw new p(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function B(e,t="/api/auth"){return K(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function x(e,t){if(e)return B(e,t);let r=(process==null?void 0:process.env)||{},i=r.BETTER_AUTH_URL||r.NEXT_PUBLIC_BETTER_AUTH_URL||r.PUBLIC_BETTER_AUTH_URL||r.NUXT_PUBLIC_BETTER_AUTH_URL||r.NUXT_PUBLIC_AUTH_URL||(r.BASE_URL!=="/"?r.BASE_URL:void 0);if(i)return B(i,t);if(typeof window!="undefined")return B(window.location.origin,t)}import"nanostores";import{betterFetch as Q}from"@better-fetch/fetch";var I={id:"redirect",name:"Redirect",hooks:{onSuccess(e){var t,r;(t=e.data)!=null&&t.url&&((r=e.data)!=null&&r.redirect)&&typeof window!="undefined"&&(window.location.href=e.data.url)}}},_={id:"add-current-url",name:"Add current URL",hooks:{onRequest(e){if(typeof window!="undefined"){let t=new URL(e.url);t.searchParams.set("currentURL",window.location.href),e.url=t}return e}}},E=new Map,k={id:"csrf",name:"CSRF Check",init(e,t){return y(this,null,function*(){if(!(t!=null&&t.baseURL))throw new p("API Base URL on the auth client isn't configured. Please pass it directly to the client `baseURL`");if((t==null?void 0:t.method)!=="GET"){t=t||{};let r=E.get("CSRF_TOKEN");if(!r){let{data:i,error:n}=yield Q("/csrf",{body:void 0,baseURL:t.baseURL,plugins:[],method:"GET",credentials:"include",customFetchImpl:t.customFetchImpl});if(n){if(n.status===404)throw new p("CSRF route not found. Make sure the server is running and the base URL is correct and includes the path (e.g. http://localhost:3000/api/auth).");if(n.status===429)return new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests"});throw new p("Failed to fetch CSRF token: "+n.message)}E.set("CSRF_TOKEN",i.csrfToken)}t.body=m(l({},t==null?void 0:t.body),{csrfToken:r})}return t.credentials="include",{url:e,options:t}})}};var v=e=>{var s,f,u,o,h,P;let t=J(m(l({baseURL:x(((s=e==null?void 0:e.fetchOptions)==null?void 0:s.baseURL)||(e==null?void 0:e.baseURL)),credentials:"include"},e==null?void 0:e.fetchOptions),{plugins:[k,I,_,...((u=(f=e==null?void 0:e.fetchOptions)==null?void 0:f.plugins)==null?void 0:u.filter(a=>a!==void 0))||[],...((o=e==null?void 0:e.plugins)==null?void 0:o.flatMap(a=>a.fetchPlugins).filter(a=>a!==void 0))||[]]})),r=(e==null?void 0:e.plugins)||[],i={},n={},d={"/sign-out":"POST","/user/revoke-sessions":"POST"},c=[{signal:"_sessionSignal",matcher(a){return a==="/sign-out"||a==="sign-up/email"||a==="/user/update"}}];for(let a of r)a.getActions&&Object.assign(i,(h=a.getActions)==null?void 0:h.call(a,t)),a.getAtoms&&Object.assign(n,(P=a.getAtoms)==null?void 0:P.call(a,t)),a.pathMethods&&Object.assign(d,a.pathMethods),a.atomListeners&&c.push(...a.atomListeners);return{pluginsActions:i,pluginsAtoms:n,pluginPathMethods:d,atomListeners:c,$fetch:t}};function $(e){return e.charAt(0).toUpperCase()+e.slice(1)}function V(e,t,r){let i=t[e],s=r||{},{fetchOptions:n,query:d}=s,c=O(s,["fetchOptions","query"]);return i||(n!=null&&n.method?n.method:c&&Object.keys(c).length>0?"POST":"GET")}function q(e,t,r,i,n){function d(c=[]){return new Proxy(function(){},{get(s,f){let u=[...c,f],o=e;for(let h of u)if(o&&typeof o=="object"&&h in o)o=o[h];else{o=void 0;break}return typeof o=="function"?o:d(u)},apply:(s,f,u)=>y(this,null,function*(){let o="/"+c.map(T=>T.replace(/[A-Z]/g,A=>`-${A.toLowerCase()}`)).join("/"),h=u[0]||{},P=u[1]||{},F=h,{query:a,fetchOptions:H}=F,j=O(F,["query","fetchOptions"]),g=l(l({},P),H),b=V(o,r,h);return yield t(o,m(l({},g),{body:b==="GET"?void 0:l(l({},j),(g==null?void 0:g.body)||{}),query:a||(g==null?void 0:g.query),method:b,onSuccess(T){return y(this,null,function*(){var L;yield(L=g==null?void 0:g.onSuccess)==null?void 0:L.call(g,T);let A=n==null?void 0:n.find(N=>N.matcher(o));if(!A)return;let U=i[A.signal];if(!U)return;let G=U.get();setTimeout(()=>{U.set(!G)},10)})}}))})})}return d()}import{atom as ee}from"nanostores";import"@better-fetch/fetch";import{atom as Z,onMount as Y}from"nanostores";var W=(e,t,r,i)=>{let n=Z({data:null,error:null,isPending:!1}),d=()=>{let s=typeof i=="function"?i({data:n.get().data,error:n.get().error,isPending:n.get().isPending}):i;return r(t,m(l({},s),{onSuccess:u=>y(void 0,null,function*(){var o;n.set({data:u.data,error:null,isPending:!1}),yield(o=s==null?void 0:s.onSuccess)==null?void 0:o.call(s,u)}),onError(u){return y(this,null,function*(){var o;n.set({error:u.error,data:null,isPending:!1}),yield(o=s==null?void 0:s.onError)==null?void 0:o.call(s,u)})},onRequest(u){return y(this,null,function*(){var h;let o=n.get();n.set({isPending:!0,data:o.data,error:o.error}),yield(h=s==null?void 0:s.onRequest)==null?void 0:h.call(s,u)})}}))};e=Array.isArray(e)?e:[e];let c=!1;for(let s of e)s.subscribe(()=>{c?d():Y(n,()=>(d(),c=!0,()=>{n.off(),s.off()}))});return n};function M(e){let t=ee(!1);return{$session:W(t,"/session",e,{method:"GET"}),_sessionSignal:t,$Infer:{}}}function we(e){let{pluginPathMethods:t,pluginsActions:r,pluginsAtoms:i,$fetch:n,atomListeners:d}=v(e),c={};for(let[P,a]of Object.entries(i))c[`use${$(P)}`]=()=>a;let{$session:s,_sessionSignal:f,$Infer:u}=M(n),o=m(l(l({},r),c),{useSession:()=>s});return q(o,n,t,m(l({},i),{_sessionSignal:f}),d)}export{we as createAuthClient};
